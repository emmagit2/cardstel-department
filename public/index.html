<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Professional Department Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- Bootstrap Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        background-color: #f4f6f9;
        font-family: 'Segoe UI', sans-serif;
        font-size: 0.9rem;
        overflow-x: hidden;
    }
.sidebar {
    background: #ffffff; /* clean white */
    color: #333;
    height: 100vh;
    transition: all 0.3s ease;
    position: fixed;
    left: 0;
    width: 200px;
    top: 0;
    overflow-y: auto;
    z-index: 2000;
    opacity: 1; /* visible */
    display: flex;
    flex-direction: column;

    /* ‚≠ê Modern shadow & design */
    box-shadow: 0 0 18px rgba(0, 0, 0, 0.15);
    border-right: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 0 16px 16px 0;
}



.sidebar.ready {
  opacity: 1;
}
    .sidebar.expanded { width: 200px; color: white;}
 .logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 10px;
    order: 0;
    margin-top: auto; /* stays at bottom nicely */
}

/* Logo image fits perfectly */
.logo-container img {
    width: 150px;       /* perfect size */
    height: auto;      /* keeps proportion */
    object-fit: contain;
    border-radius: 8px;
}

/* Text beside logo */
.logo-container span {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    letter-spacing: 0.3px;
}

    .logo-container img { width: 35px; height: 35px; border-radius: 6px; }
    .logo-container span { font-weight: bold; font-size: 0.85rem; white-space: nowrap; }
    .sidebar:not(.expanded) .logo-container { order: 99; margin-top: auto; padding-bottom: 15px; }
    .sidebar:not(.expanded) .logo-container span { display: none; }
    .toggle-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1rem;
        padding: 8px 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        text-align: left;
        margin-bottom: 15px;
    }
    .toggle-btn {
    display: none;
  }
    .toggle-btn span { font-size: 0.85rem; }
    .sidebar:not(.expanded) .toggle-btn span { display: none; }
 .sidebar .nav-link {
    color: #444;
    padding: 12px 14px;
    border-radius: 12px;
    margin-bottom: 6px;
    font-weight: 500;
    transition: 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sidebar .nav-link:hover {
    background: #f5f5f5;
    color: #000;
    transform: translateX(4px);
}

.sidebar .nav-link.active {
    background: #ffe5d6; 
    color: #d56b32;
    font-weight: 600;
}

    .sidebar:not(.expanded) .nav-link span { display: none; }
    .sidebar:not(.expanded) .nav-link i { margin-right: 0; }
    .content { margin-left: 65px; transition: margin-left 0.3s; }
    .sidebar.expanded ~ .content { margin-left: 200px; }
    .top-bar {
        background: white;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #ddd;
    }
    .user-menu {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    .user-menu img { width: 35px; height: 35px; border-radius: 50%; }
    .collapse { display: none; }
.collapse.show { display: block; }

    @media(max-width: 768px) {
        .sidebar { left: -200px; width: 200px; box-shadow: 2px 0 8px rgba(0,0,0,0.2); }
        .sidebar.expanded { left: 0; }
        .top-bar { justify-content: flex-start; gap: 10px; }
        .hamburger-btn {
            background: none; border: none; font-size: 1.2rem; color: #182848;
        }

        .content { margin-left: 0 !important; }
        .overlay {
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1999;
        }
        .overlay.active { display: block; }
    }
     .gradient-card {
    border-radius: 1rem;
    padding: 1rem;
    transition: transform 0.2s;
  }
  .gradient-card:hover {
    transform: translateY(-5px);
  }
  .bg-gradient-primary {
    background: linear-gradient(135deg,#0d6efd,#85c1ff);
  }


  .icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  .bg-gradient-primary { background: linear-gradient(135deg,#0d6efd,#85c1ff);}
  .bg-gradient-success { background: linear-gradient(135deg,#28a745,#85e085);}
  .bg-gradient-warning { background: linear-gradient(135deg,#ffc107,#ffe085);}
  .bg-gradient-danger { background: linear-gradient(135deg,#dc3545,#ff7f7f);}
  .summary-card, .filter-box, .card, .table-responsive {
    transition: transform 0.2s;
  }
  .summary-card:hover, .filter-box:hover, .card:hover, .table-responsive:hover {
    transform: translateY(-5px);
  }
/* ===== Modern Deep Orange Theme with Elegant Table Titles ===== */
:root {
  --deep-orange: #e65100;
  --light-orange: #ff9800;
  --orange-gradient: linear-gradient(135deg, #ff6f00, #e65100, #bf360c);
  --dark-gray: #212121;
  --soft-gray: #f5f5f5;
}

/* ===== Main Panel ===== */
#jobManagementPanel {
  background: linear-gradient(to bottom right, #ffffff, #f9f9f9);
  border: 1px solid #eee;
  border-radius: 18px;
  padding: 25px;
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
  animation: fadeIn 0.9s ease;
}

/* ===== Main Header Card ===== */
.job-header-card {
  background: var(--orange-gradient);
  border-radius: 15px;
  color: #fff;
  padding: 25px 20px;
  margin-bottom: 25px;
  box-shadow: 0 4px 20px rgba(230, 81, 0, 0.25);
  animation: fadeSlide 1s ease;
  position: relative;
  overflow: hidden;
}

.job-header-card::after {
  content: "";
  position: absolute;
  top: 0;
  right: -50px;
  width: 180px;
  height: 100%;
  background: rgba(255, 255, 255, 0.15);
  transform: skew(-25deg);
}

.job-header-card h3 {
  font-weight: 700;
  font-size: 1.8rem;
  letter-spacing: 0.8px;
}

.job-header-card small {
  opacity: 0.9;
  font-size: 0.9rem;
}

/* ===== Filter Section ===== */
#jobManagementPanel .card {
  border: none;
  border-radius: 15px;
  background: linear-gradient(to right, #fff, #fff9f4);
  box-shadow: 0 3px 10px rgba(255, 111, 0, 0.15);
  transition: 0.3s ease;
}

#jobManagementPanel .card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 18px rgba(255, 111, 0, 0.25);
}

#jobManagementPanel .form-label {
  color: var(--deep-orange);
  font-weight: 600;
}

#jobManagementPanel .form-control,
#jobManagementPanel .form-select {
  border: 1px solid #ddd;
  border-radius: 10px;
  transition: all 0.3s;
}

#jobManagementPanel .form-control:focus,
#jobManagementPanel .form-select:focus {
  border-color: var(--light-orange);
  box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.25);
}

/* ===== Filter Buttons ===== */
#applyFilters {
  background: var(--orange-gradient);
  border: none;
  color: #fff;
  border-radius: 10px;
  padding: 8px 15px;
  transition: 0.3s;
}
#applyFilters:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 10px rgba(255, 111, 0, 0.3);
}

#resetFilters {
  background: #9e9e9e;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  transition: 0.3s;
}
#resetFilters:hover {
  background: #616161;
}

/* ===== Section Titles for Tables ===== */
.table-title {
  background: var(--orange-gradient);
  color: #fff;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.9rem;
  letter-spacing: 0.8px;
  border-radius: 10px 10px 0 0;
  padding: 10px 15px;
  box-shadow: 0 3px 10px rgba(230, 81, 0, 0.25);
  display: flex;
  align-items: center;
  justify-content: space-between;
  animation: fadeSlide 1.2s ease;
}

/* Subtle glowing animation for table titles */
.table-title span {
  animation: glowText 3s infinite ease-in-out;
}

@keyframes glowText {
  0%, 100% { text-shadow: 0 0 5px rgba(255,255,255,0.2); }
  50% { text-shadow: 0 0 15px rgba(255,255,255,0.6); }
}

/* ===== Table Styling ===== */
.table-wrapper {
  overflow-x: auto;
  background-color: var(--soft-gray);
  border-radius: 0 0 12px 12px;
  padding: 10px;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}

#jobManagementPanel table {
  min-width: 900px;
  border-collapse: separate;
  width: 100%;
  border-spacing: 0;
  border-radius: 10px;
  overflow: hidden;
}

/* Animated dark gradient header */
#jobManagementPanel thead {
  background: linear-gradient(135deg, #424242, #616161, #757575);
  color: #fff;
  animation: headerGradient 6s infinite alternate ease-in-out;
}

#jobManagementPanel th {
  font-size: 0.8rem;
  font-weight: 600;
  padding: 12px;
  text-transform: uppercase;
  text-align: center;
  white-space: nowrap;
}

#jobManagementPanel tbody tr {
  transition: 0.25s ease;
}

#jobManagementPanel tbody tr:hover {
  background-color: rgba(255, 111, 0, 0.08);
  transform: scale(1.01);
}

/* ===== Animations ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(25px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeSlide {
  from { opacity: 0; transform: translateX(-25px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes headerGradient {
  0% { background: linear-gradient(135deg, #424242, #616161); }
  50% { background: linear-gradient(135deg, #757575, #424242); }
  100% { background: linear-gradient(135deg, #616161, #212121); }
}

/* ===== Table Section Titles: Magical & Modern ===== */
.table-title {
  background: var(--orange-gradient); /* Deep orange gradient */
  color: #fff;
  font-weight: 600;
  font-size: 0.8rem; /* slightly smaller for elegance */
  text-transform: uppercase;
  letter-spacing: 0.6px;
  border-radius: 8px 8px 0 0;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 8px; /* space between icon and text */
  box-shadow: 0 3px 10px rgba(230, 81, 0, 0.25);
  justify-content: flex-start;
  animation: fadeSlide 1.2s ease;
}

/* Icon next to the title */
.table-title i {
  font-size: 1rem;
  color: #fff;
  animation: glowIcon 2.5s infinite alternate ease-in-out;
}

/* Glowing effect for text */
.table-title span {
  display: inline-block;
  animation: glowText 3s infinite ease-in-out;
}

/* Subtle glowing animation for text */
@keyframes glowText {
  0%, 100% { text-shadow: 0 0 3px rgba(255,255,255,0.2); }
  50% { text-shadow: 0 0 10px rgba(255,255,255,0.6); }
}

/* Subtle glowing animation for icon */
@keyframes glowIcon {
  0%, 100% { text-shadow: 0 0 2px rgba(255,255,255,0.2); }
  50% { text-shadow: 0 0 8px rgba(255,255,255,0.8); }
}

  /* Overall Section Header */
  .overall-summary h2 {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.6rem;
    color: #222;
    font-weight: 700;
  }

  .overall-summary .header-icon {
    background: linear-gradient(135deg, #ff6a00, #ff4500);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(255, 90, 0, 0.4);
  }

  /* Summary Cards */
  .summary-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .summary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 25px rgba(255, 100, 0, 0.2);
  }

  .icon-gradient {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #ff6a00, #ff4500);
    border-radius: 50%;
    color: #fff;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(255,90,0,0.3);
  }

  .summary-card h6 {
    margin: 0;
    font-size: 0.875rem;
    color: #666;
  }

  .summary-card h3 {
    margin: 0;
    font-weight: 700;
    color: #222;
    font-size: 1.3rem;
  }

.overall-summary h2 .header-icon {
  width: 45px;
  height: 45px;
  background: linear-gradient(135deg, #ff7a00, #ff4500);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

/* Subtitle */
.overall-summary h2 + p {
  margin-left: 60px; /* aligns subtitle with text, not icon */
  color: #6c757d;
  font-size: 0.95rem;
}


/* Filter Box Items */
.filter-box {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
    justify-content: center;

  align-items: center;
}

/* Each filter item */
.filter-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-left: 2.1rem;
}

/* Align labels nicely on desktop */
@media (min-width: 576px) {
  .filter-item {
    flex-direction: row;
    align-items: center;
  }
}

/* Modern rounded inputs */
.filter-box select,
.filter-box input {
  border-radius: 50px !important;
  padding: 0.375rem 0.75rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  border: 1px solid #ddd;
  transition: all 0.2s ease;
}

.filter-box select:focus,
.filter-box input:focus {
  border-color: #ff4500;
  box-shadow: 0 0 6px rgba(255,69,0,0.3);
  outline: none;
}

/* Gradient Apply Button */
.btn-gradient-orange {
  background: linear-gradient(135deg, #ff8c00, #ff4500);
  color: #fff;
  border: none;
  transition: all 0.3s ease;
}
.btn-gradient-orange:hover {
  background: linear-gradient(135deg, #ff7000, #ff3a00);
  box-shadow: 0 4px 10px rgba(255,69,0,0.3);
}

/* Card Header Gradient */
.card-header.bg-gradient-orange {
  background: linear-gradient(135deg, black, black);
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  border-bottom: none;
}

/* Card Body */
.card-body {
  background-color: #f9f9f9;
}

/* Optional: subtle shadow for canvas container */
.card-body canvas {
  border-radius: 0.5rem;
}


 /* Cards */
  #bankSections .card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    transition: transform 0.3s, box-shadow 0.3s;
  }
  #bankSections .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 25px rgba(255, 90, 0, 0.15);
  }

  /* Card Header */
  #customBankRecordsPanel .card-header {
    background: #000; /* black header */
    background: linear-gradient(135deg, #000, #222);
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
    border-radius: 16px 16px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 1rem;
  }

  /* Header buttons */
  #customBankRecordsPanel .card-header .btn {
    font-weight: 600;
    font-size: 0.8rem;
    border-radius: 6px;
    background: #222;
    color: #ff6a00;
    border: 1px solid #ff6a00;
    transition: 0.2s;
  }
  #customBankRecordsPanel .card-header .btn:hover {
    background: #ff6a00;
    color: #fff;
  }

  /* Filters */
  #customBankRecordsPanel .card-body .form-label {
    font-weight: 600;
    color: #666;
    font-size: 0.8rem;
  }
  #customBankRecordsPanel .form-select,
  #customBankRecordsPanel .form-control {
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    font-size: 0.85rem;
  }

  /* Apply button */
  #bankApply_custom {
    background: linear-gradient(135deg, #ff6a00, #ff4500);
    border: none;
  }
  #bankApply_custom:hover {
    background: linear-gradient(135deg, #ff4500, #ff6a00);
  }

  /* Table headers */
  #customBankRecordsPanel table thead,
  #bankSections table thead {
    background: #000; /* black header */
    color: #ff6a00;   /* deep orange touch */
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  /* Table styling */
  #bankSections table {
    border-collapse: separate;
    border-spacing: 0 6px;
    font-size: 0.875rem;
  }
  #bankSections table tbody tr {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  }
  #bankSections table td,
  #bankSections table th {
    vertical-align: middle;
    text-align: center;
    border: none;
    padding: 0.6rem 0.75rem;
  }


.network-modal {
  position: fixed;
  top: 0px;
  right: 20px;
  background: #fff;
  display: none;
  width: 300px;
  z-index: 10000000000;
  transition: all 0.4s ease;
  animation: slideIn 0.4s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.network-modal.online {
  border-left-color: #198754;
}


/* Base Modal Style */
.fetch-modal {
  position: fixed;
  top: 10px;
  right: 20px;
  background: #ffffff;
  padding: 14px 20px;
  border-radius: 16px;
  border-left: 5px solid #0d6efd;
  width: 320px;
  display: none;
  z-index: 10000000000;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  animation: fadeIn 0.4s ease;
}

.fetch-inner {
  display: flex;
  align-items: center;
}

.fetch-icon {
  width: 32px;
  height: 32px;
  flex-shrink: 0;
}

/* Animations */
@keyframes spin {
  100% {
    transform: rotate(360deg);
  }
}

@keyframes fadeIn {
  from {
    transform: translateY(40px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes checkmark {
  0% {
    stroke-dashoffset: 24;
  }
  100% {
    stroke-dashoffset: 0;
  }
}

@keyframes errorShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-3px); }
}

/* Theme States */
.fetch-modal.success {
  border-left-color: #198754;
}

.fetch-modal.error {
  border-left-color: #dc3545;
}

.fetch-modal.error .fetch-icon {
  animation: errorShake 0.5s ease;
}

/* ===== Header ===== */
.modern-header {
  background: #fff; /* clean white */
  border-radius: 1rem;
  padding: 1rem 1.5rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}

.modern-header:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

.modern-header h3 {
  color: #e65100; /* deep orange */
  font-size: 1.4rem;
}

.modern-header small {
  color: #666;
}

/* ===== Export Buttons ===== */
.btn-pdf {
  background-color: #e65100;
  color: #fff;
  border-radius: 0.6rem;
  border: none;
  font-weight: 500;
  transition: background 0.2s, transform 0.2s;
}

.btn-pdf:hover {
  background-color: #ff6f00;
  transform: translateY(-1px);
}

.btn-excel {
  background-color: #fff; /* white background */
  color: #43a047; /* green for Excel */
  border-radius: 0.6rem;
  border: none;
  font-weight: 500;
  transition: background 0.2s, transform 0.2s, color 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.btn-excel:hover {
  background-color: #f1f1f1;
  color: #388e3c;
  transform: translateY(-1px);
}

/* ===== Modern Table ===== */
.modern-table-container {
  background: #fff;
  border-radius: 1rem;
  padding: 1rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.05);
}

.modern-table {
  border-collapse: separate !important;
  border-spacing: 0 0.5rem;
}

.modern-table thead tr {
  background-color: #ffe0b2; /* light deep-orange header */
  color: #e65100;
  font-weight: 600;
  border-radius: 0.8rem;
}

.modern-table thead th {
  border: none !important;
  padding: 0.75rem 1rem;
}

.modern-table tbody tr {
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  border-radius: 0.6rem;
  transition: transform 0.2s, box-shadow 0.2s;
}

.modern-table tbody tr:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

.modern-table td {
  border: none !important;
  padding: 0.75rem 1rem;
  vertical-align: middle;
}

.modern-table th:first-child {
  border-top-left-radius: 0.8rem;
}

.modern-table th:last-child {
  border-top-right-radius: 0.8rem;
}
  .smart-table {
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    border-collapse: separate;
    border-spacing: 0;
  }

  .smart-table thead {
    background: #fff7f3;
    color: #ff5722;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border-bottom: 2px solid #ffe0d5;
  }

  .smart-table th {
    vertical-align: middle;
    padding: 14px 16px;
    border-bottom: 2px solid #ffe0d5;
    font-size: 0.9rem;
  }

  .smart-table td {
    padding: 14px 16px;
    border-bottom: 1px solid #f1f1f1; /* middle border line between rows */
    vertical-align: middle;
  }

  .smart-table tbody tr:last-child td {
    border-bottom: none; /* remove bottom line for last row */
  }

  .smart-table tbody tr:hover {
    background-color: #fff4ef;
    transition: all 0.2s ease-in-out;
  }

  .smart-btn {
    border: none;
    outline: none;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
  }

  .smart-btn.view {
    background-color: #007bff;
    color: #fff;
  }

  .smart-btn.edit {
    background-color: #ffc107;
    color: #222;
  }

  .smart-btn.delete {
    background-color: #dc3545;
    color: #fff;
  }

  .smart-btn.view:hover { background-color: #0069d9; }
  .smart-btn.edit:hover { background-color: #e0a800; }
  .smart-btn.delete:hover { background-color: #c82333; }

  .smart-badge {
    padding: 6px 10px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .smart-badge.success {
    background-color: #d4edda;
    color: #155724;
  }

  .smart-header-icon {
    color: #ff5722;
    margin-right: 6px;
    font-size: 1rem;
  }


/* Table Rows */
#devicesTable tbody tr {
  transition: transform 0.15s, box-shadow 0.15s;
}

#devicesTable tbody tr:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}

/* Buttons in table */
#devicesTable tbody .btn {
  transition: transform 0.15s, box-shadow 0.15s;
}

#devicesTable tbody .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

/* Responsive table */
@media (max-width: 576px) {
  #devicesTable thead {
    display: none;
  }
  #devicesTable tbody tr {
    display: block;
    margin-bottom: 0.75rem;
  }
  #devicesTable tbody td {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
  }
  #devicesTable tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
  }
}


/* Scrollbar for modal body */
#showDevicesModal .modal-body::-webkit-scrollbar {
  width: 6px;
}

#showDevicesModal .modal-body::-webkit-scrollbar-thumb {
  background-color: rgba(255,107,0,0.7);
  border-radius: 3px;
}

#showDevicesModal .modal-body::-webkit-scrollbar-track {
  background-color: #f0f0f0;
  border-radius: 3px;
}

/* Table row hover effect */
#devicesTable tbody tr {
  transition: transform 0.15s, box-shadow 0.15s;
}

#devicesTable tbody tr:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.12);
}

/* Buttons hover effect */
#devicesTable tbody .btn {
  transition: transform 0.15s, box-shadow 0.15s;
}

#devicesTable tbody .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}


  /* Scoped CSS */
  .modern-dashboard {
    background-color: #fff;
    font-family: 'Inter', sans-serif;
    color: #333;
  }

  .modern-dashboard .card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    background-color: #fff;
  }

  .modern-dashboard .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }

  .modern-dashboard .form-control,
  .modern-dashboard .form-select {
    border-radius: 10px;
    border: 1px solid #ddd;
    padding: 0.55rem 0.75rem;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
  }

  .modern-dashboard .form-control:focus,
  .modern-dashboard .form-select:focus {
    border-color: #ff7a00;
    box-shadow: 0 0 0 0.15rem rgba(255, 122, 0, 0.2);
  }

  .modern-dashboard .btn-black {
    background-color: #1a1a1a;
    color: #fff;
    border-radius: 10px;
    border: none;
    transition: background-color 0.2s ease, transform 0.1s ease;
  }

  .modern-dashboard .btn-black:hover {
    background-color: #000;
    transform: scale(1.03);
  }

  .modern-dashboard table {
    border-radius: 12px;
    overflow: hidden;
  }

  .modern-dashboard thead.table-light {
    background-color: #fff3e6;
    color: #222;
    font-weight: 600;
  }

  .modern-dashboard tbody tr:hover {
    background-color: #fff9f4;
  }

  .modern-dashboard h5.card-title {
    color: #ff7a00;
    font-weight: 700;
  }
  .toner-dashboard {
    background-color: #fff;
    font-family: 'Inter', sans-serif;
    color: #333;
  }

  .toner-dashboard .card {
    border-radius: 16px;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .toner-dashboard .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }

  .toner-dashboard .form-control,
  .toner-dashboard .form-select {
    border-radius: 10px;
    border: 1px solid #ddd;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    padding: 0.55rem 0.75rem;
    transition: all 0.2s ease;
  }

  .toner-dashboard .form-control:focus,
  .toner-dashboard .form-select:focus {
    border-color: #ff7a00;
    box-shadow: 0 0 0 0.15rem rgba(255,122,0,0.2);
  }

  .toner-dashboard .btn-black {
    background-color: #1a1a1a;
    color: #fff;
    border-radius: 10px;
    border: none;
    transition: background-color 0.2s ease, transform 0.1s ease;
  }

  .toner-dashboard .btn-black:hover {
    background-color: #000;
    transform: scale(1.03);
  }

  .toner-dashboard table {
    border-radius: 12px;
    overflow: hidden;
  }

  .toner-dashboard thead.table-light {
    background-color: #fff3e6;
    color: #222;
    font-weight: 600;
  }

  .toner-dashboard tbody tr:hover {
    background-color: #fff9f4;
  }

  .toner-dashboard h3,
  .toner-dashboard h5.card-title {
    color: #ff7a00;
  }


  .qc-report-dashboard {
    background-color: #fff;
    font-family: 'Inter', sans-serif;
    color: #333;
  }

  .qc-report-dashboard .card {
    border-radius: 16px;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .qc-report-dashboard .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }

  .qc-report-dashboard .qc-table th,
  .qc-report-dashboard .qc-table td {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
  }

  .qc-report-dashboard .qc-table thead th {
    font-weight: 600;
    text-transform: uppercase;
  }

  .qc-report-dashboard .qc-table tbody tr:hover {
    background-color: #fff4e6;
  }

  .qc-report-dashboard .qc-table td {
    background-color: #fff;
    box-shadow: inset 0 -1px 0 rgba(0,0,0,0.05);
    border: none;
  }

  .qc-report-dashboard .qc-table th {
    border: none;
  }


  /* General dashboard card style */
  .qc-report-dashboard, #qcControlPanel .card {
    background-color: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    font-family: 'Inter', sans-serif;
  }

  .qc-report-dashboard .card:hover, #qcControlPanel .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }

  /* Table Styling */
  .qc-report-dashboard .qc-table th,
  .qc-report-dashboard .qc-table td {
    padding: 0.45rem 0.65rem;
    font-size: 0.85rem;
  }

  .qc-report-dashboard .qc-table tbody tr:hover {
    background-color: #fff4e6;
  }

  .qc-report-dashboard .qc-table td {
    background-color: #fff;
    box-shadow: inset 0 -1px 0 rgba(0,0,0,0.05);
    border: none;
  }

  .qc-report-dashboard .qc-table th {
    border: none;
    font-weight: 600;
  }

  /* Filter inputs */
  #qcControlPanel select,
  #qcControlPanel input {
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  #applyFilterBtn {
    border-radius: 8px;
    transition: all 0.25s ease;
  }

  #applyFilterBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.2);
  }

<!-- Optional: Add professional CSS -->

  #qcControlPanel .card {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  #qcControlPanel .form-control,
  #qcControlPanel .form-select {
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: all 0.25s ease;
  }

  #qcControlPanel .qc-table {
    table-layout: fixed;
    font-size: 0.9rem;
  }

  #qcControlPanel .qc-table td[contenteditable="true"] {
    background-color: #fff9f5;
    cursor: text;
  }

  #qcControlPanel .qc-table td[contenteditable="true"]:focus {
    outline: 2px solid #ff6b00;
    background-color: #fff;
  }

  #qcControlPanel .btn-primary {
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }
/* Table Styling */
.qc-table { border-collapse: separate; border-spacing:0; width:100%; font-size:0.95rem; border-radius:8px; overflow:hidden; }
.qc-table th, .qc-table td { padding:0.6rem; text-align:center; border:0; }
.qc-table thead tr:first-child th { border-bottom:2px solid #d9751c; }
.qc-table thead tr:nth-child(2) th { border-bottom:2px solid #ffa94d; }
.qc-table tbody tr.main-row { background:#fff; transition:all 0.3s; }
.qc-table tbody tr.main-row:hover { background:#fff6e5; }
.qc-table tbody tr.ot-row { font-style:italic; background:#fff3d6; border-left:4px solid #ff6b00; }
.qc-table tbody tr.totals-row { background:#ffe8cc; font-weight:600; border-top:3px solid #ff6b00; }
.day-block { background:#ff6b00; color:white; }
.table-responsive { overflow-x:auto; }
#applyFilterBtn { background:#212529; color:white; }
#applyFilterBtn:hover { background:#343a40; }
.pagination .page-link { color:#ff6b00; }
.pagination .page-item.active .page-link { background:#ff6b00; border-color:#ff6b00; }
.pagination .page-link:hover { background:#ffd8a8; }

/* Dotted orange border for overtime input */
.dotted-orange { border: 2px dotted #ff6b00 !important; border-radius: 5px; padding: 0.4rem; }
/* TOP BAR - 70% floating */
.top-bar {
    width: 70%;
    height: 80px;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: space-between; /* hamburger left, logo center, user right */
    padding: 0 20px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.15); /* deeper shadow for dashboard feel */
    position: fixed;
    top: 20px;
    left: 60%;
    transform: translateX(-50%);
    z-index: 3000;
    border-radius: 14px;
}

/* Hamburger menu */
.hamburger-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #444;
}

/* Centered logo - modern dashboard look */
.topbar-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 10px 20px;
    border-radius: 12px;
}

/* Logo image - larger & clean */
.topbar-logo img {
    width: 120px;
    height: auto;
    object-fit: contain;
    border-radius: 8px;
    display: block;
}



/* User menu */
.user-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.user-menu img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.user-menu span {
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.user-menu i {
    font-size: 14px;
    color: #555;
}
.department-panel{
  margin-top: 10%;
}

</style>


</head>
<body>

<!-- Overlay for Mobile -->
<div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  
  
<nav class="nav flex-column flex-grow-1">
  <!-- Home -->
  <a href="#" class="nav-link" data-target="homePanel">
    <i class="fas fa-house"></i> <span>Home</span>
  </a>

  <!-- Production Management Dropdown -->
  <div class="nav-item">
    <a href="#" class="nav-link" data-bs-toggle="collapse" data-bs-target="#productionSubmenu" aria-expanded="false">
      <i class="fas fa-box"></i> <span>Production Management</span>
      <i class="fas fa-caret-down ms-auto"></i>
    </a>

    <div class="collapse" id="productionSubmenu">
      <!-- smaller sub-links -->
      <a href="#" class="nav-link ps-4" data-target="deviceUsagePanel"><i class="fas fa-microchip"></i> Device Usage</a>
      <a href="#" class="nav-link ps-4" data-target="personTeamPanel"><i class="fas fa-users-cog"></i> Person Team</a>
      <a href="#" class="nav-link ps-4" data-target="jobManagementPanel"><i class="fas fa-tasks"></i> Job Management</a>
      <a href="#" class="nav-link ps-4" data-target="cardRecordsPanel"><i class="fas fa-id-card"></i> Card Records</a>
      <!-- <a href="#" class="nav-link ps-4" data-target="machineReportPanel"><i class="fas fa-cogs"></i> Machine Report</a> -->

      <!-- ‚úÖ QC Control Unit (no submenu) -->
      <a href="#" class="nav-link ps-4" data-target="qcControlPanel">
        <i class="fas fa-check-circle"></i> QC Control Unit
      </a>

      <!-- ‚úÖ Telcom Unit (no submenu) -->
    <!--   <a href="#" class="nav-link ps-4" data-target="telcomUnitPanel">
        <i class="fas fa-satellite-dish"></i> Telcom Unit
      </a> -->
    </div>
  </div>

  <!-- Staff Management Dropdown -->
  <div class="nav-item">
    <a href="#" class="nav-link" data-bs-toggle="collapse" data-bs-target="#staffSubmenu" aria-expanded="false">
      <i class="fas fa-users"></i> <span>Staff Management</span>
      <i class="fas fa-caret-down ms-auto"></i>
    </a>
    <div class="collapse" id="staffSubmenu">
      <a href="#" class="nav-link ps-4" data-target="staffListPanel"><i class="fas fa-user-cog"></i> Manage Staff</a>
    </div>
  </div>

  <!-- ‚úÖ IT Department (Separate Main Menu) -->
<!--   <div class="nav-item">
    <a href="#" class="nav-link" data-bs-toggle="collapse" data-bs-target="#itDepartmentSubmenu" aria-expanded="false">
      <i class="fas fa-desktop"></i> <span>IT Department</span>
      <i class="fas fa-caret-down ms-auto"></i>
    </a>
    <div class="collapse" id="itDepartmentSubmenu">
      <a href="#" class="nav-link ps-4" data-target="systemMaintenancePanel"><i class="fas fa-tools"></i> System Maintenance</a>
      <a href="#" class="nav-link ps-4" data-target="softwareDeploymentPanel"><i class="fas fa-upload"></i> Software Deployment</a>
      <a href="#" class="nav-link ps-4" data-target="itSupportPanel"><i class="fas fa-headset"></i> IT Support</a>
    </div>
  </div> -->
</nav>



</div>

<!-- Main Content -->
<div class="content">
<div class="top-bar">
    <!-- Hamburger menu -->
    <button class="hamburger-btn d-md-none" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Centered Company Logo -->
    <div class="topbar-logo">
        <img src="icons/cardstel_logo.png" alt="Cardstel Logo"><br>
    </div>

    <!-- User dropdown -->
    <div class="dropdown ms-auto">
        <div class="user-menu" data-bs-toggle="dropdown">
            <img src="https://via.placeholder.com/40" alt="User">
            <span>John Doe</span>
            <i class="fas fa-caret-down"></i>
        </div>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#">Profile</a></li>
            <li><a class="dropdown-item" href="#">Settings</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Logout</a></li>
        </ul>
    </div>
</div>





    <!-- Panels -->
    <div id="homePanel" class="p-3 department-panel">
        <h3>üè† Home</h3>
        <p>Welcome to the Department Management Dashboard. Select a menu option to view details.</p>
    </div>

<div id="deviceUsagePanel" class="p-4 bg-light rounded-4 shadow-sm department-panel">

<!-- Modern Header Section -->
<!-- Modern Header -->
<div class="modern-header d-flex justify-content-between align-items-center mb-4 p-3 rounded-3 shadow-sm">

  <!-- Title -->
  <div>
    <h3 class="fw-bold mb-1"><i class="bi bi-bar-chart-line"></i> Device Usage</h3>
    <small class="text-muted">Monitor printing activity & analytics</small>
  </div>

  <!-- Export Buttons -->
  <div class="d-flex gap-2">
    <button class="btn btn-pdf btn-sm">
      <i class="bi bi-download"></i> Export PDF
    </button>
    <button class="btn btn-excel btn-sm">
      <i class="bi bi-file-earmark-spreadsheet"></i> Export Excel
    </button>
  </div>
</div>
<section class="total-prints-section container my-4">

<!-- Action Buttons Row (Show / Add) -->
<div class="row mb-3">
  <div class="col d-flex justify-content-end gap-2">
    <!-- Show Devices Button -->
    <button 
      class="btn" 
      style="
        background-color: #000; 
        color: white; 
        border-radius: 0.5rem; 
        padding: 0.5rem 1rem; 
        font-weight: 500; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        transition: transform 0.2s, box-shadow 0.2s;
      " 
      data-bs-toggle="modal" 
      data-bs-target="#showDevicesModal"
      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)';"
      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
    >
      <i class="fas fa-eye me-2"></i>Show Devices
    </button>

    <!-- Add Device Button -->
    <button 
      class="btn" 
      style="
        background-color: #ff6b00; 
        color: #fff; 
        border-radius: 0.5rem; 
        padding: 0.5rem 1rem; 
        font-weight: 500; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        transition: transform 0.2s, box-shadow 0.2s;
      " 
      data-bs-toggle="modal" 
      data-bs-target="#addDeviceModal"
      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)';"
      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
    >
      <i class="fas fa-plus-circle me-2"></i>Add Device
    </button>
  </div>
</div>


<!-- Device & Date Range Selector Row -->
<div class="row g-3 align-items-end mb-4">
  <!-- Device Selector -->
  <div class="col-md-3">
    <label for="totalPrintDevice" class="form-label fw-semibold text-dark">Select Device:</label>
    <select
      id="totalPrintDevice"
      class="form-select shadow-sm"
      style="
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: all 0.25s ease;
      "
      onfocus="this.style.boxShadow='0 0 0 3px rgba(255,107,0,0.2)';"
      onblur="this.style.boxShadow='none';"
    >
      <option value="">-- Select Device --</option>
      <!-- JS will populate options -->
    </select>
  </div>

  <!-- Start Date -->
  <div class="col-md-3">
    <label for="customStartDate" class="form-label fw-semibold text-dark">Start Date:</label>
    <input
      type="date"
      id="customStartDate"
      class="form-control shadow-sm"
      style="
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: all 0.25s ease;
      "
      onfocus="this.style.boxShadow='0 0 0 3px rgba(255,107,0,0.2)';"
      onblur="this.style.boxShadow='none';"
    >
  </div>

  <!-- End Date -->
  <div class="col-md-3">
    <label for="customEndDate" class="form-label fw-semibold text-dark">End Date:</label>
    <input
      type="date"
      id="customEndDate"
      class="form-control shadow-sm"
      style="
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: all 0.25s ease;
      "
      onfocus="this.style.boxShadow='0 0 0 3px rgba(255,107,0,0.2)';"
      onblur="this.style.boxShadow='none';"
    >
  </div>

  <!-- Run Button -->
  <div class="col-md-3 d-flex align-items-end">
    <button
      id="runCustomQuery"
      class="btn w-100 d-flex align-items-center justify-content-center shadow-sm"
      style="
        background-color: #1a1a1a;
        color: #fff;
        font-weight: 500;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        transition: all 0.25s ease;
      "
      onmouseover="this.style.backgroundColor='#000'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(0,0,0,0.25)';"
      onmouseout="this.style.backgroundColor='#1a1a1a'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';"
    >
      <i class="fas fa-play me-2" style="color: #ff6b00;"></i>Run
    </button>
  </div>
</div>

<!-- Side by Side: Total & Breakdown -->
<div class="row g-3 align-items-stretch" style="font-family: 'Segoe UI', sans-serif;">

  <!-- Total Prints Card -->
  <div class="col-md-4">
    <div
      id="startCustomTotalCard"
      class="rounded-4 shadow-sm text-center p-4 h-100"
      style="
        background-color: #fff;
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      "
      onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 14px rgba(0,0,0,0.15)';"
      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)';"
    >
      <div style="width: 45px; height: 45px; background-color: #ff6b00; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
        <i class="fas fa-print text-white" style="font-size: 1.2rem;"></i>
      </div>
      <div class="text-dark fw-semibold mb-1" style="font-size: 0.9rem;">Total Prints (Custom)</div>
      <div id="startCustomTotalValue" class="fw-bold" style="font-size: 2rem; color: #ff6b00;">0</div>
      <div class="small text-muted" style="font-size: 0.8rem;">Updated live</div>
    </div>
  </div>

  <!-- Divider Line -->
  <div class="col-md-1 d-none d-md-flex align-items-center justify-content-center">
    <div style="width: 1px; background-color: #e0e0e0; height: 75%;"></div>
  </div>

  <!-- Daily Breakdown Panel -->
  <div class="col-md-7">
    <div
      id="startCustomRawData"
      class="rounded-4 shadow-sm p-4 h-100"
      style="
        background-color: #fff;
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        font-size: 0.9rem;
        color: #333;
        overflow-y: auto;
        max-height: 220px;
        line-height: 1.4;
        transition: all 0.3s ease;
      "
      onmouseover="this.style.boxShadow='0 6px 14px rgba(0,0,0,0.15)';"
      onmouseout="this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)';"
    >
      <div class="d-flex align-items-center mb-2">
        <i class="fas fa-chart-bar me-2" style="color: #ff6b00;"></i>
        <span class="fw-semibold" style="color: #1a1a1a;">Daily Breakdown</span>
      </div>
      <div id="startCustomRawDataContent">
        <span class="text-muted">Select a device and date range to see daily breakdown...</span>
      </div>
    </div>
  </div>

</div>


</section>
<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 350px;">
    <div class="modal-content shadow-sm rounded-4 border-0" style="background-color: #fff; color: #333; font-family: 'Segoe UI', sans-serif;">

      <!-- Modal Header -->
      <div class="modal-header" style="border-bottom: none; justify-content: center; padding: 1rem; position: relative;">
        <div style="width: 35px; height: 35px; background-color: #cc4b00; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem;">
          <i class="fas fa-plus" style="color: #fff; font-size: 1rem;"></i>
        </div>
        <h5 class="modal-title" id="addDeviceModalLabel" style="font-size: 1rem; color: #000;">
          Add Device
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" style="position: absolute; right: 1rem;"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body" style="padding: 0.75rem 1rem;">
        <form id="addDeviceForm">
          <div class="mb-3">
            <label class="form-label fw-semibold" style="color: #333; font-size: 0.9rem;">Device Name:</label>
            <input type="text" class="form-control" id="deviceName" placeholder="Enter device name" required
                   style="background-color: #f5f5f5; color: #333; border-radius: 0.5rem; border: none; padding: 0.45rem 0.75rem;">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold" style="color: #333; font-size: 0.9rem;">Device Type:</label>
            <input type="text" class="form-control" id="deviceType" placeholder="Enter device type" required
                   style="background-color: #f5f5f5; color: #333; border-radius: 0.5rem; border: none; padding: 0.45rem 0.75rem;">
          </div>
          <div class="text-end">
            <button type="submit" 
                    class="btn" 
                    style="background-color: #cc4b00; color: #fff; font-weight: 500; padding: 0.45rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: transform 0.2s, box-shadow 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 10px rgba(0,0,0,0.25)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.15)';">
              Save Device
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Show Devices Modal -->
<div class="modal fade" id="showDevicesModal" tabindex="-1" aria-labelledby="showDevicesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 650px;">
    <div class="modal-content shadow-lg rounded-4 border-0" style="font-family: 'Segoe UI', sans-serif;">

      <!-- Modal Header -->
      <div class="modal-header bg-dark text-white" style="border-bottom: none; justify-content: center; position: relative;">
        <h5 class="modal-title" id="showDevicesModalLabel" style="font-weight: 600; font-size: 0.95rem;">
          <i class="fas fa-desktop me-2 text-warning"></i>Devices List
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="position: absolute; right: 1rem;"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body" style="padding: 0.75rem 1rem; max-height: 350px; overflow-y: auto;">
        <div class="table-responsive">
          <table id="devicesTable" class="table align-middle text-center mb-0" style="min-width: 100%; border-collapse: separate; border-spacing: 0 0.3rem; font-size: 0.85rem;">
            <thead style="background-color: #ff6b00; color: #fff; font-weight: 600;">
              <tr>
                <th style="border-top-left-radius: 0.35rem; padding: 0.5rem;">#</th>
                <th>Device Name</th>
                <th>Device Type</th>
                <th style="border-top-right-radius: 0.35rem;">Actions</th>
              </tr>
            </thead>
            <tbody id="devicesTableBody">
              <tr style="background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                <td>1</td>
                <td>Printer A</td>
                <td>LaserJet</td>
                <td>
                  <button class="btn btn-sm" style="background-color: #ff6b00; color: #fff; border-radius: 0.35rem; margin-right: 0.25rem; padding: 0.25rem 0.5rem;">
                    <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                  </button>
                  <button class="btn btn-sm" style="background-color: #1e1e1e; color: #fff; border-radius: 0.35rem; padding: 0.25rem 0.5rem;">
                    <i class="fas fa-trash-alt" style="font-size: 0.75rem;"></i>
                  </button>
                </td>
              </tr>
              <!-- Additional rows dynamically added via JS -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- Modern Dashboard Section -->
<div class="modern-dashboard container-fluid py-4">
  <div class="row g-4">

    <!-- Left Panel -->
    <div class="col-lg-8">
      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="deviceSelect">Select Device</label>
              <select class="form-select" id="deviceSelect">
                <option value="">-- Select Device --</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label fw-semibold" for="timeRangeSelect">View By</label>
              <select class="form-select" id="timeRangeSelect">
                <option value="week">Week</option>
                <option value="month">Month</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label fw-semibold">Select Date</label>
              <input type="week" class="form-control" id="weekPicker">
              <input type="month" class="form-control" id="monthPicker" style="display:none;">
            </div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card">
        <div class="card-body">
          <h5 id="chartTitle" class="card-title mb-3">üìà Printing Trends</h5>
          <canvas id="deviceUsageChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="col-lg-4">
      <!-- Search -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label fw-semibold" for="jobSearch">Search Job ID</label>
            <div class="input-group">
              <input type="text" class="form-control" id="jobSearchs" placeholder="Enter Job ID">
              <button class="btn btn-black" id="jobSearchBtn"><i class="bi bi-search"></i></button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold" for="customDate">Custom Date</label>
            <input type="date" class="form-control mb-2" id="customDate">
            <button class="btn btn-black w-100" id="customDateSearchBtn"><i class="bi bi-calendar-event"></i> Search by Date</button>
          </div>
        </div>
      </div>

      <!-- Jobs Table -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Recent Jobs</h5>
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped align-middle table-hover">
              <thead class="table-light">
                <tr>
                  <th>Job ID</th>
                  <th>Date & Time</th>
                  <th>Range</th>
                  <th>Total Prints</th>
                  <th>Bank</th>
                </tr>
              </thead>
              <tbody id="jobsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>





<div class="toner-dashboard p-4 rounded-4 shadow-sm mt-5">

  <!-- Title Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-1" id="tonerTitle">
        <i class="bi bi-printer"></i> Toner Usage
      </h3>
      <small class="text-muted">Track toner install & replacement history</small>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" id="exportPdfBtn">
        <i class="bi bi-download"></i> Export PDF
      </button>
      <button class="btn btn-outline-success btn-sm" id="exportExcelBtn">
        <i class="bi bi-file-earmark-spreadsheet"></i> Export Excel
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="row g-3 mb-4">
    <!-- Device Filter -->
    <div class="col-md-4">
      <label class="form-label fw-semibold" for="tonerDeviceSelect">Select Device</label>
      <select class="form-select" id="tonerDeviceSelect">
        <option value="">-- All Devices --</option>
      </select>
    </div>

    <!-- Toner Code Search -->
    <div class="col-md-4">
      <label class="form-label fw-semibold" for="tonerSearch">Search Toner Code</label>
      <div class="input-group">
        <input type="text" class="form-control" id="tonerSearch" placeholder="Enter toner code">
        <button class="btn btn-black" id="tonerSearchBtn">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>

    <!-- Date Range Filter -->
    <div class="col-md-4">
      <label class="form-label fw-semibold" for="tonerDateRange">Custom Date</label>
      <input type="date" class="form-control mb-2" id="tonerDateRangeStart" placeholder="Start Date">
      <input type="date" class="form-control" id="tonerDateRangeEnd" placeholder="End Date">
      <button class="btn btn-black w-100 mt-2" id="tonerDateSearchBtn">
        <i class="bi bi-calendar-event"></i> Filter by Date
      </button>
    </div>
  </div>

  <!-- Toner Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title mb-3 fw-semibold">Toner History</h5>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-sm table-striped align-middle table-hover">
          <thead class="table-light">
            <tr>
              <th>Toner Code</th>
              <th>Device</th>
              <th>Install Date</th>
              <th>Replace Date</th>
              <th>Total Prints</th>
            </tr>
          </thead>
          <tbody id="tonerTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>




</div>


<!-- Person Team Panel -->
<div id="personTeamPanel" class="p-4 department-panel bg-white shadow-lg rounded-3" style="display:none;">

    <!-- Title -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0">üë• Perso Team</h3>
        <small class="text-muted">Track staff printing activity, jobs, and targets</small>
    </div>

    <!-- Staff Selection + Search -->
    <div class="row g-4 align-items-end mb-4">
        <!-- Select Staff -->
        <div class="col-md-4">
            <label class="form-label fw-semibold">Select Staff</label>
            <select id="staffSelect" class="form-select">
                <!-- Dynamic options inserted by JS -->
            </select>
        </div>

        <!-- Search Staff -->
        <!-- <div class="col-md-4">
            <label class="form-label fw-semibold">Search Staff</label>
            <div class="input-group">
                <input type="text" id="staffSearch" class="form-control" placeholder="Search staff...">
                <button class="btn btn-primary" id="staffSearchBtn">Search</button>
            </div>
        </div> -->

        <!-- Performance View -->
        <!-- <div class="col-md-4">
            <label class="form-label fw-semibold">Performance View</label>
            <select id="performanceView" class="form-select">
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
            </select>
        </div> -->
    </div>

    <!-- Optional: Custom Date Filter -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <label class="form-label fw-semibold">Start Date</label>
            <input type="date" id="customDateStart" class="form-control">
        </div>
        <div class="col-md-6">
            <label class="form-label fw-semibold">End Date</label>
            <input type="date" id="customDateEnd" class="form-control">
        </div>
        <div class="col-md-12 mt-2">
            <button class="btn btn-secondary" id="customDateSearchBtnjob">Filter by Date</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="row g-4">
        <!-- LEFT: Job Table -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-semibold">Job Records</h5>
                        <div class="input-group input-group-sm w-auto">
                            <input type="text" id="jobSearchjob" class="form-control" placeholder="Search Job ID">
                            <button class="btn btn-outline-primary" id="jobSearchBtnjob">Search</button>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 280px; overflow-y:auto;">
                        <table class="table table-sm table-striped align-middle" id="jobTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Job ID</th>
                                    <th>Time</th>
                                    <th>Date</th>
                                    <th>Qty Printed</th>
                                    <th>Amount</th>
                                    <th>Range</th>
                                    <th>Printer Used</th>
                                </tr>
                            </thead>
                            <tbody id="staffJobsTableBody">
                                <!-- Dynamically filled via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Staff Performance Graph -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3 fw-semibold">üìä Staff Work Performance</h5>
                    <canvas id="staffJobChart" height="250"></canvas>
                </div>
            </div>

        </div>
    </div>

    <!-- Active Days & Target -->
   <!--  <div class="card shadow-sm border-0 mt-4">
        <div class="card-body">
            <h5 class="card-title mb-3 fw-semibold">üìÖ Active Days & Monthly Target</h5>
            <canvas id="activeDaysChart" height="200"></canvas>
            <div class="mt-3">
                <label class="form-label fw-semibold">Target Progress</label>
                <div class="progress">
                    <div class="progress-bar bg-success" id="targetProgressBar" style="width: 0%;">0% of Target Reached</div>
                </div>
            </div>
        </div>
    </div> -->

</div>
<div id="cardRecordsPanel" class="p-4 department-panel">

  <!-- ================== Overall Summary ================== -->
  <div class="overall-summary mb-5">
    <h2 class="fw-bold mb-1 d-flex align-items-center gap-3">
      <span class="header-icon d-flex align-items-center justify-content-center">
        <i class="bi bi-credit-card-2-front fs-3 text-white"></i>
      </span>
      Overall Card Printing Summary
    </h2>
    <p class="text-muted mb-4 fs-6">
      Track your card displacement, quantity, and what‚Äôs printed
    </p>

    <!-- Summary Cards -->
    <div class="row g-4">
      <div class="col-md-3">
        <div class="summary-card">
          <div class="icon-gradient"><i class="bi bi-card-text"></i></div>
          <div>
            <h6>Cards Today</h6>
            <h3 id="todayCount">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <div class="icon-gradient"><i class="bi bi-calendar-week"></i></div>
          <div>
            <h6>This Week</h6>
            <h3 id="weekCount">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <div class="icon-gradient"><i class="bi bi-calendar2-month"></i></div>
          <div>
            <h6>This Month</h6>
            <h3 id="monthCount">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <div class="icon-gradient"><i class="bi bi-bank"></i></div>
          <div>
            <h6>Top Bank</h6>
            <h3 id="topBank">N/A</h3>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== Filter Box for Overall Graph ================== -->
  <div class="filter-box shadow-sm rounded-4 p-3 mb-4 d-flex flex-wrap justify-content-start align-items-center gap-3 bg-white">
    <div class="filter-item d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2">
      <label for="overallBankSelect" class="fw-semibold small text-muted mb-0">Bank</label>
      <select id="overallBankSelect" class="form-select form-select-sm shadow-sm rounded-pill">
        <option value="">All Banks</option>
      </select>
    </div>

    <div class="filter-item d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2">
      <label for="overallFilterType" class="fw-semibold small text-muted mb-0">Filter Type</label>
      <select id="overallFilterType" class="form-select form-select-sm shadow-sm rounded-pill">
        <option value="week">Weekly</option>
        <option value="month">Monthly</option>
      </select>
    </div>

    <div class="filter-item d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2" id="weekFilterBox">
      <label for="overallWeek" class="fw-semibold small text-muted mb-0">Select Week</label>
      <input id="overallWeek" type="week" class="form-control form-control-sm shadow-sm rounded-pill">
    </div>

    <div class="filter-item d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2" id="monthFilterBox" style="display:none;">
      <label for="overallMonth" class="fw-semibold small text-muted mb-0">Select Month</label>
      <input id="overallMonth" type="month" class="form-control form-control-sm shadow-sm rounded-pill">
    </div>

    <button id="applyOverall" class="btn btn-gradient-orange px-4 py-2">
      <i class="bi bi-funnel-fill me-1"></i> Apply
    </button>
  </div>

  <!-- ================== Overall Graph ================== -->
  <div class="card shadow-sm rounded-4 mb-5 border-0 overflow-hidden">
    <div class="card-header bg-gradient-orange text-white fw-semibold d-flex align-items-center gap-2">
      <i class="bi bi-graph-up fs-5"></i> Overall Print Trend
    </div>
    <div class="card-body bg-light p-4">
      <canvas id="overallPrintChart" height="180"></canvas>
    </div>
  </div>

  <!-- ================== Bank Sections ================== -->
  <div id="bankSections" class="mb-5">
    <div class="row g-4">

      <!-- Left Panel: Bank Custom Summary -->
      <div class="col-lg-7">
        <div id="customBankRecordsPanel" class="p-3">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">üí≥ Bank Print Summary</h6>
              <div class="d-flex gap-2">
                <button id="exportExcel_custom" class="btn btn-sm">
                  <i class="bi bi-file-earmark-excel"></i> Excel
                </button>
                <button id="exportPDF_custom" class="btn btn-sm">
                  <i class="bi bi-file-earmark-pdf"></i> PDF
                </button>
              </div>
            </div>

            <!-- Filters -->
            <div class="card-body border-bottom bg-light">
              <div class="row g-2 align-items-end">
                <div class="col-6 col-md-4">
                  <label for="bankSelect_custom" class="form-label mb-1">Bank</label>
                  <select id="bankSelect_custom" class="form-select form-select-sm shadow-sm">
                    <option value="">Select Bank</option>
                  </select>
                </div>
                <div class="col-6 col-md-4">
                  <label for="bankMonth_custom" class="form-label mb-1">Month</label>
                  <input id="bankMonth_custom" type="month" class="form-control form-control-sm shadow-sm">
                </div>
                <div class="col-6 col-md-4">
                  <label for="bankWeek_custom" class="form-label mb-1">Week</label>
                  <input id="bankWeek_custom" type="week" class="form-control form-control-sm shadow-sm">
                </div>
                <div class="col-6 col-md-4">
                  <label for="bankDay_custom" class="form-label mb-1">Day</label>
                  <input id="bankDay_custom" type="date" class="form-control form-control-sm shadow-sm">
                </div>
                <div class="col-md-8">
                  <label class="form-label mb-1">Custom Range</label>
                  <div class="d-flex gap-2">
                    <input id="bankStart_custom" type="date" class="form-control form-control-sm shadow-sm">
                    <input id="bankEnd_custom" type="date" class="form-control form-control-sm shadow-sm">
                  </div>
                </div>
                <div class="col-12 text-end mt-3">
                  <button id="bankApply_custom" class="btn btn-primary btn-sm px-4">
                    <i class="bi bi-funnel-fill"></i> Apply
                  </button>
                </div>
              </div>
            </div>

            <!-- Results Table -->
            <div class="card-body p-0">
              <div class="table-responsive" style="max-height: 380px; overflow-y:auto;">
                <table class="table table-hover align-middle mb-0 text-center">
                  <thead>
                    <tr>
                      <th>Date / Period</th>
                      <th>Total Cards Printed</th>
                    </tr>
                  </thead>
                  <tbody id="bankSummary_custom"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Bank Jobs Table -->
      <div class="col-lg-5">
        <div class="card h-100 p-4 bg-white">
          <div class="mb-3">
            <label for="bankSelect" class="form-label fw-bold">Select Bank</label>
            <select id="bankSelect" class="form-select form-select-md"></select>
          </div>
          <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="üîç Search by Job ID or Staff" style="flex: 1 1 150px;">
            <input id="dateInput" type="date" class="form-control form-control-sm" style="flex: 1 1 120px;">
            <button id="applyBankJobs" class="btn btn-primary btn-sm">Apply</button>
            <button class="btn btn-outline-success btn-sm ms-auto">üìÑ Export Excel</button>
            <button class="btn btn-outline-danger btn-sm">üñ®Ô∏è Export PDF</button>
          </div>
          <div class="table-responsive" style="max-height: 400px; overflow-y:auto;">
            <table class="table table-hover align-middle mb-0 text-center">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Quantity</th>
                  <th>Job ID</th>
                  <th>Staff</th>
                  <th>Machine</th>
                </tr>
              </thead>
              <tbody id="bankJobsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div> <!-- row -->
  </div> <!-- bankSections -->

</div> <!-- cardRecordsPanel -->

<div id="jobManagementPanel" class="p-4 bg-light rounded-4 shadow-sm department-panel" style="display:none;">


<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="fw-bold mb-1">
      <i class="fas fa-briefcase"></i> Job Management
    </h3>
    <small class="text-muted">Monitor all jobs by bank, shift, and completion status</small>
  </div>

  <!-- Button to open Add Job Modal -->
  <button class="btn" data-bs-toggle="modal" data-bs-target="#jobModal" style="background-color: #FF7F32; color: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 5px;">
    <i class="fas fa-plus-circle me-2"></i> Add Job
  </button>
</div>


<!-- üî∏ Buttons to switch between Batch & Job Process -->
<div class="d-flex gap-2 mb-4">
  <button id="batchButton" class="btn btn-dark px-3 py-2 rounded-3">
    <i class="fas fa-layer-group me-2"></i> Batch
  </button>
  <button id="jobProcessButton" class="btn btn-outline-dark px-3 py-2 rounded-3">
    <i class="fas fa-cogs me-2"></i> Job Process
  </button>
</div>





<!-- üîπ BATCH SECTION (Your Existing One) -->
<!-- ======================== -->
<div id="batchSection">
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="filterJobCode" class="form-label fw-semibold">Job Code</label>
          <input type="text" id="filterJobCode" class="form-control" placeholder="Enter Job Code">
        </div>
        <div class="col-md-3">
          <label for="filterBank" class="form-label fw-semibold">Bank</label>
          <select id="filterBank" class="form-select">
            <option value="">All Banks</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="filterShift" class="form-label fw-semibold">Shift</label>
          <select id="filterShift" class="form-select">
            <option value="">All</option>
            <option value="morning">Morning</option>
            <option value="night">Night</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="filterStartDate" class="form-label fw-semibold">Start Date</label>
          <input type="date" id="filterStartDate" class="form-control">
        </div>
        <div class="col-md-2">
          <label for="filterEndDate" class="form-label fw-semibold">End Date</label>
          <input type="date" id="filterEndDate" class="form-control">
        </div>
      </div>

      <div class="mt-3 text-end">
        <button id="applyFilters" class="btn btn-success btn-sm">
          <i class="fas fa-filter"></i> Apply Filters
        </button>
        <button id="resetFilters" class="btn btn-secondary btn-sm">
          <i class="fas fa-undo"></i> Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Example batch tables (replace or keep your originals) -->
  <h5 class="mt-3 fw-bold">Job Overview (Batch Summary)</h5>
  <div class="table-responsive mb-4" style="max-height: 300px; overflow-y: auto;">
    <table class="table table-hover table-striped align-middle table-bordered">
      <thead class="table-dark text-center">
        <tr>
          <th>#</th>
          <th>Job Code</th>
          <th>Bank</th>
          <th>Card Ready</th>
          <th>Mailer Ready</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="jobOverviewTableBody" class="text-center"></tbody>
    </table>
  </div>
  <!-- Job Overview Table -->
  <h5 class="mt-3 fw-bold">Job Overview (Batch Summary)</h5>
  <div class="table-responsive mb-4" style="max-height: 300px; overflow-y: auto;">
    <table class="table table-hover table-striped align-middle table-bordered">
      <thead class="table-dark text-center">
        <tr>
          <th>#</th>
          <th>Job Code</th>
          <th>Bank</th>
          <th>Card Ready</th>
          <th>Mailer Ready</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="jobOverviewTableBody" class="text-center"></tbody>
    </table>
  </div>

  <div class="row">
    <!-- Card Printing Table -->
    <div class="col-lg-6 mb-4">
      <h5 class="fw-bold">Card Printing Details</h5>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-hover table-striped align-middle table-bordered">
          <thead class="table-dark text-center">
            <tr>
             <th>s/n</th>
              <th>Date / Time</th>
              <th>Shift</th>
              <th>Operator</th>
              <th>Device</th>
              <th>Total Qty</th>
              <th>Completed Qty</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody id="cardPrintingTableBody" class="text-center"></tbody>
        </table>
      </div>
    </div>

    <!-- Mailer Printing Table -->
    <div class="col-lg-6 mb-4">
      <h5 class="fw-bold">Mailer Printing Details</h5>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-hover table-striped align-middle table-bordered">
          <thead class="table-dark text-center">
            <tr>
             <th>S/n</th>
              <th>Date / Time</th>
              <th>Shift</th>
              <th>Operator</th>
               <th>Device</th>
               <th>Total Qty</th>
              <th>Completed Qty</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody id="mailerPrintingTableBody" class="text-center"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>



  


  <!-- ‚úÖ Job Process Section (hidden until clicked) -->
  <div id="jobProcessSection" class="card shadow-sm border-0 p-3 mb-4" >
    <h5 class="fw-bold mb-3"><i class="fas fa-search me-2 text-dark"></i> Job Processing Tracker</h5>

    <!-- Search & Filters -->
    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Search by Job Code</label>
        <input type="text" id="searchJobCode" class="form-control" placeholder="Enter job code...">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Start Date</label>
        <input type="date" id="searchStartDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">End Date</label>
        <input type="date" id="searchEndDate" class="form-control">
      </div>
      <div class="col-md-2 text-end">
        <button id="applySearch" class="btn btn-dark btn-sm px-3"><i class="fas fa-filter"></i> Filter</button>
      </div>
    </div>


<div class="table-responsive mb-4">
  <table class="table smart-table align-middle text-center">
    <thead>
      <tr>
        <th><i class="fas fa-hashtag smart-header-icon"></i>#</th>
        <th><i class="fas fa-calendar-alt smart-header-icon"></i> Time</th>
        <th><i class="fas fa-briefcase smart-header-icon"></i>Job Code</th>
        <th><i class="fas fa-university smart-header-icon"></i>Bank</th>
        <th><i class="fas fa-check-circle smart-header-icon"></i>Processed</th>
        <th><i class="fas fa-cogs smart-header-icon"></i>Action</th>
      </tr>
    </thead>
    <tbody id="processedJobsTableBody">
      <tr>
        <td>1</td>
        <td>2025-11-08 10:45 AM</td>
        <td>JOB-0012</td>
        <td>Zenith Bank</td>
        <td><span class="smart-badge success">Completed</span></td>
        <td>
          <button class="smart-btn view me-1"><i class="fas fa-eye"></i></button>
          <button class="smart-btn edit me-1"><i class="fas fa-edit"></i></button>
          <button class="smart-btn delete"><i class="fas fa-trash"></i></button>
        </td>
      </tr>
      <!-- Dynamic rows go here -->
    </tbody>
  </table>
</div>

  </div>

</div>
<!-- Add/Edit Job Modal -->
<div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4">

      <!-- Header -->
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="jobModalLabel">
          <i class="fas fa-briefcase me-2"></i> Add Job
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body px-4 py-3">
        <form id="jobForm">
          <!-- Notice -->
          <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert"
               style="background-color: #FF7F32; color: black; border-radius: 8px;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Notice:</strong> Once Job ID is created, it can be edited.
            Please ensure it‚Äôs correct before saving.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>

          <!-- Select Bank -->
          <div class="mb-3">
            <label for="bankSelects" class="form-label fw-semibold">Select Bank</label>
            <select id="bankSelects" class="form-select shadow-sm custom-select"></select>
          </div>

          <!-- Job ID -->
          <div class="mb-3">
            <label for="jobId" class="form-label fw-semibold">Job ID</label>
            <input type="text" id="jobId" class="form-control shadow-sm" placeholder="Enter job ID" required>
            <small class="text-muted fst-italic">
              Format auto-detects (e.g. <strong>wema_12345</strong> or <strong>J123456</strong>)
            </small>
          </div>

          <!-- Quantity -->
          <div class="mb-4">
            <label for="quantity" class="form-label fw-semibold">Quantity</label>
            <input type="number" id="quantity" class="form-control shadow-sm" placeholder="Enter quantity" required>
          </div>

          <!-- Submit Button -->
          <div class="text-center">
            <button type="submit" class="btn btn-sm text-white px-4 py-2 rounded-3 shadow-sm"
                    style="background-color: #FF7F32; font-weight: bold;">
              <i class="fas fa-save me-2"></i> Save Job
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content shadow-lg rounded-4 border-0" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      
      <!-- Modal Header -->
      <div class="modal-header bg-dark text-white rounded-top-4">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-trash-alt me-2"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" id="closeDeleteModal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body d-flex align-items-center gap-2" style="font-size: 0.95rem;">
        <i class="fas fa-exclamation-triangle text-warning fa-lg"></i>
        <span>Are you sure you want to delete this job?</span>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer justify-content-center gap-2 py-2">
        <button type="button" class="btn btn-sm btn-outline-secondary fw-semibold" id="cancelDeleteBtn">
          <i class="fas fa-times me-1"></i> Cancel
        </button>
        <button type="button" class="btn btn-sm btn-danger fw-semibold" id="confirmDeleteBtn">
          <i class="fas fa-trash-alt me-1"></i> Delete
        </button>
      </div>

    </div>
  </div>
</div>




<!-- Machine Report Panel -->
<div id="machineReportPanel" class="p-4 department-panel bg-light" style="display:none; border-radius:12px;">
  <h3 class="mb-4 text-primary fw-bold">‚öôÔ∏è Machine Report</h3>

  <!-- Filters Row -->
  <div class="row g-3 mb-4">
    <!-- Keyword Search 1 -->
    <div class="col-md-3">
      <input type="text" id="keywordSearch1" class="form-control shadow-sm" placeholder="üîç Search by keyword...">
    </div>

    <!-- Keyword Search 2 (Report ID or Job ID) -->
    <div class="col-md-3">
      <input type="text" id="keywordSearch2" class="form-control shadow-sm" placeholder="üîç Search by Report ID...">
    </div>

    <!-- Date Picker -->
    <div class="col-md-3">
      <input type="date" id="datePicker" class="form-control shadow-sm">
    </div>

    <!-- Dropdown: Machine -->
    <div class="col-md-3">
      <select id="machineSelect" class="form-select shadow-sm">
        <option value="">-- Choose Machine --</option>
        <option value="A">Machine A</option>
        <option value="B">Machine B</option>
        <option value="C">Machine C</option>
      </select>
    </div>
  </div>

  <!-- Report List -->
<div id="machineReportList" class="d-flex flex-column gap-3">

    <!-- Example Report Card: Breakdown -->
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title text-secondary mb-0">Report ID: MR-002</h6>
          <span class="badge bg-danger">Breakdown</span>
        </div>
        <p class="mb-1"><strong>Date of Breakdown:</strong> 2025-08-30</p>
        <p class="text-muted">Machine B required lubrication. Temperature stable at 67¬∞C.</p>
      </div>
    </div>

    <!-- Example Report Card: Maintenance -->
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title text-secondary mb-0">Report ID: MR-003</h6>
          <span class="badge bg-warning text-dark">Maintenance</span>
        </div>
        <p class="mb-1"><strong>Date of Maintenance:</strong> 2025-08-31</p>
        <p class="text-muted">Machine C showed vibration increase. Scheduled inspection needed.</p>
      </div>
    </div>

    <!-- Example Report Card: Operational -->
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title text-secondary mb-0">Report ID: MR-004</h6>
          <span class="badge bg-success">Operational</span>
        </div>
        <p class="mb-1"><strong>Status Date:</strong> 2025-09-01</p>
        <p class="text-muted">Machine A running normally. No issues detected.</p>
      </div>
    </div>

  </div>
</div>

<div class="p-4 department-panel b" id="qcControlPanel">

  <!-- Filter Panel -->
  <div class="card shadow-sm border-0 p-3 mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-semibold" for="filterBank">Select Bank / Client</label>
        <select id="filterBank" class="form-select">
          <option value="">-- All Banks --</option>
          <option value="CardstelOpay">CardstelOpay</option>
          <option value="CardstelPalmpay"> CardstelPalmpay</option>
          <option value="CardstelBank">CardstelBank</option>
          <option value="CardstelBranch"> CardstelBranch</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold" for="filterTimeFrame">Time Frame</label>
        <select id="filterTimeFrame" class="form-select">
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="year">This Year</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold" for="filterWeek">Week</label>
        <input type="week" id="filterWeek" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold" for="filterMonth">Month</label>
        <input type="month" id="filterMonth" class="form-control">
      </div>

      <div class="col-md-1">
        <label class="form-label fw-semibold" for="filterYear">Year</label>
        <input type="number" id="filterYear" class="form-control" placeholder="YYYY">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold" for="filterDay">Day</label>
        <input type="date" id="filterDay" class="form-control">
      </div>

      <div class="col-md-12 d-flex justify-content-end mt-2">
        <button id="applyFilterBtn" class="btn btn-dark shadow-sm">
          <i class="bi bi-funnel-fill me-2"></i> Apply Filters
        </button>
      </div>
    </div>
  </div>
<!-- QC Table Card -->
<div class="card shadow-sm border-0">
  <div class="card-body p-3">

    <!-- Add QC Entry Button -->
    <div class="d-flex justify-content-end mb-3">
      <button id="openQcModalBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#qcEntryModalUnique">
        Add QC Entry
      </button>
    </div>

    <div class="table-responsive">
      <table class="table qc-table align-middle text-center" id="qcTable">
        <thead>
          <tr style="background-color:#ff6b00; color:white;">
    <!-- QC Table -->
            <th rowspan="2">Bank / Client</th>
            <th colspan="2" class="day-block">Monday</th>
            <th colspan="2" class="day-block">Tuesday</th>
            <th colspan="2" class="day-block">Wednesday</th>
            <th colspan="2" class="day-block">Thursday</th>
            <th colspan="2" class="day-block">Friday</th>
            <th colspan="2" class="day-block">Saturday</th>
            <th colspan="2" class="day-block">Sunday</th>
            <th rowspan="2">Total / Shift</th>
          </tr>
          <tr style="background-color:#ff9a33; color:white;">
            <th>Day</th><th>Night</th>
            <th>Day</th><th>Night</th>
            <th>Day</th><th>Night</th>
            <th>Day</th><th>Night</th>
            <th>Day</th><th>Night</th>
            <th>Day</th><th>Night</th>
            <th>Day</th><th>Night</th>
          </tr>
        </thead>
        <tbody id="qcTableBody">
          <!-- Rows will be dynamically generated -->
        </tbody>
        <tfoot>
          <tr class="totals-row" style="background:#ffe8cc; font-weight:600;">
            <td>Total / Shift</td>
            <!-- Day/Night totals will be generated by JS -->
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>



<!-- Modal -->
<div class="modal fade" id="addCardModal" tabindex="-1" aria-labelledby="addCardModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">

      <!-- Modal Header -->
      <div class="modal-header" style="background:#e65100;">
        <h5 class="modal-title text-white" id="addCardModalLabel">Add New Card</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="addCardForm">
          
          <!-- Card Name -->
          <div class="mb-3">
            <label for="cardName" class="form-label fw-semibold">Card Name</label>
            <input type="text" class="form-control rounded-3" id="cardName" placeholder="Enter Card Name" required>
          </div>

          <!-- Card Brand -->
          <div class="mb-3">
            <label for="cardBrand" class="form-label fw-semibold">Card Brand</label>
            <input type="text" class="form-control rounded-3" id="cardBrand" placeholder="Enter Card Brand" required>
          </div>

          <!-- Card Quantity -->
          <div class="mb-3">
            <label for="cardQty" class="form-label fw-semibold">Card Quantity</label>
            <input type="number" class="form-control rounded-3" id="cardQty" placeholder="Enter Quantity" min="1" required>
          </div>

          <!-- Vendor/Brand -->
          <div class="mb-3">
            <label for="vendorName" class="form-label fw-semibold">Received From (Vendor/Brand)</label>
            <input type="text" class="form-control rounded-3" id="vendorName" placeholder="Enter Vendor Name" required>
          </div>

          <button type="submit" class="btn text-white rounded-3" 
                  style="background:#e65100; width:100%; padding:10px;">Add Card</button>
        </form>
      </div>

    </div>
  </div>
</div>
<script>
document.getElementById('addCardForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    card_name: document.getElementById('cardName').value,
    card_brand: document.getElementById('cardBrand').value,
    quantity: parseInt(document.getElementById('cardQty').value),
    vendor: document.getElementById('vendorName').value
  };

  try {
    const res = await fetch('/api/cards/add', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(res.ok){
      alert('Card added successfully!');
      // Close modal
      const modalEl = document.getElementById('addCardModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
      // Optionally reload table
    } else {
      alert('Failed to add card.');
    }
  } catch(err){
    console.error(err);
    alert('Error occurred while adding card.');
  }
});
</script>
<!-- Button to Open Modal -->


<!-- Modal -->
<div class="modal fade" id="postProcessModal" tabindex="-1" aria-labelledby="postProcessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content rounded-4 shadow-lg">

      <!-- Modal Header -->
      <div class="modal-header" style="background:#e65100;">
        <h5 class="modal-title text-white" id="postProcessModalLabel">Update Card Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4">
        <form id="postProcessForm">

          <!-- Card Name -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Card Name</label>
            <select id="cardNameSelect" class="form-select mb-2 rounded-3">
              <option value="">Select Card Name</option>
              <option value="Card A">Card A</option>
              <option value="Card B">Card B</option>
            </select>
            <input type="text" id="cardNameText" class="form-control rounded-3" placeholder="Or enter Card Name manually" style="display:none;">
            <button class="btn btn-light border mt-1 w-100" type="button" id="toggleCardName" title="Switch Input">
              <i class="bi bi-pencil-square text-dark"></i> Switch Input
            </button>
          </div>

          <!-- Card Brand -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Card Brand</label>
            <select id="cardBrandSelect" class="form-select mb-2 rounded-3">
              <option value="">Select Card Brand</option>
              <option value="Visa">Visa</option>
              <option value="MasterCard">MasterCard</option>
            </select>
            <input type="text" id="cardBrandText" class="form-control rounded-3" placeholder="Or enter Card Brand manually" style="display:none;">
            <button class="btn btn-light border mt-1 w-100" type="button" id="toggleCardBrand" title="Switch Input">
              <i class="bi bi-pencil-square text-dark"></i> Switch Input
            </button>
          </div>

          <!-- Personalized Quantity -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Personalized Quantity</label>
            <input type="number" class="form-control rounded-3 shadow-sm" id="personalizedQty" placeholder="Enter number" min="0" required>
          </div>

          <!-- Ongoing Quantity -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Ongoing Quantity</label>
            <input type="number" class="form-control rounded-3 shadow-sm" id="ongoingQty" placeholder="Enter number" min="0" required>
          </div>

          <!-- Duplicates Quantity -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Duplicates Quantity</label>
            <input type="number" class="form-control rounded-3 shadow-sm" id="duplicatesQty" placeholder="Enter number" min="0" required>
          </div>

          <!-- Shift -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Shift</label>
            <select id="shiftSelect" class="form-select rounded-3" required>
              <option value="">Select Shift</option>
              <option value="Day">Day</option>
              <option value="Night">Night</option>
            </select>
          </div>

          <!-- Submit Button -->
          <button type="submit" class="btn text-white rounded-3 shadow-sm" style="background:#e65100; width:100%; padding:10px;">
            Update Status
          </button>
        </form>
      </div>

    </div>
  </div>
</div>
<script>
// Toggle Card Name Input
document.getElementById('toggleCardName').addEventListener('click', () => {
  const select = document.getElementById('cardNameSelect');
  const text = document.getElementById('cardNameText');
  if(select.style.display !== 'none'){
    select.style.display = 'none';
    text.style.display = 'block';
  } else {
    select.style.display = 'block';
    text.style.display = 'none';
  }
});

// Toggle Card Brand Input
document.getElementById('toggleCardBrand').addEventListener('click', () => {
  const select = document.getElementById('cardBrandSelect');
  const text = document.getElementById('cardBrandText');
  if(select.style.display !== 'none'){
    select.style.display = 'none';
    text.style.display = 'block';
  } else {
    select.style.display = 'block';
    text.style.display = 'none';
  }
});

// Form Submission
document.getElementById('postProcessForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const cardName = document.getElementById('cardNameSelect').value || document.getElementById('cardNameText').value;
  const cardBrand = document.getElementById('cardBrandSelect').value || document.getElementById('cardBrandText').value;

  const payload = {
    card_name: cardName,
    card_brand: cardBrand,
    personalized: parseInt(document.getElementById('personalizedQty').value),
    ongoing: parseInt(document.getElementById('ongoingQty').value),
    duplicates: parseInt(document.getElementById('duplicatesQty').value),
    shift: document.getElementById('shiftSelect').value
    // Optionally include batch ID or server timestamp
  };

  try {
    const res = await fetch('/api/cards/update-status', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(res.ok){
      alert('Card status updated!');
      const modalEl = document.getElementById('postProcessModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
      // Optionally refresh table dynamically
    } else {
      alert('Failed to update status.');
    }
  } catch(err){
    console.error(err);
    alert('Error updating card status.');
  }
});
</script>



<!-- Modals (Confirm, Warning, Add QC Entry) -->
<!-- Confirm Edit Modal -->
<div class="modal fade" id="editConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="fas fa-pen"></i> Confirm Edit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editConfirmForm">
          <div class="mb-3">
            <label class="form-label">Reason for Change</label>
            <input type="text" id="changeRemark" class="form-control" placeholder="Why did you make this change?" required>
          </div>
          <button type="submit" class="btn btn-warning w-100">Confirm & Save</button>
        </form>
      </div>
    </div>
  </div>
</div>



<!-- Add QC Entry Modal -->
<div class="modal fade" id="qcEntryModalUnique" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm rounded-4 border-0 bg-white">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add QC Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addQCForm">
          <div class="mb-3">
            <label class="form-label fw-semibold" for="qcBank">Select Bank</label>
            <select class="form-select" id="qcBank" required>
              <option value="">-- Select Bank --</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold" for="qcShift">Select Shift</label>
            <select class="form-select" id="qcShift" required>
              <option value="">-- Select Shift --</option>
              <option value="day">Day</option>
              <option value="night">Night</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold" for="qcTotal">Total Prints</label>
            <input type="number" class="form-control" id="qcTotal" placeholder="Enter total" required>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="overtimeSwitch">
            <label class="form-check-label" for="overtimeSwitch">Overtime?</label>
          </div>
          <div class="mb-3" id="overtimeQtyDiv" style="display:none;">
            <label class="form-label fw-semibold" for="overtimeQty">Overtime Quantity</label>
            <input type="number" class="form-control" id="overtimeQty" placeholder="Enter overtime quantity">
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-dark w-100">Add Entry</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- MODERN WARNING MODAL -->
<div class="modal fade" id="warningModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-0 rounded-3 shadow-lg" style="overflow:hidden;">
      
      <!-- HEADER -->
      <div class="modal-header bg-warning text-dark border-0 py-2 px-3">
        <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
        <h6 class="modal-title fw-bold mb-0">Warning</h6>
        <button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- BODY -->
      <div class="modal-body text-center py-3 px-3 fs-6" id="warningModalMessage" style="line-height:1.4;">
        <!-- Message inserted dynamically -->
      </div>
      
      <!-- FOOTER -->
      <div class="modal-footer border-0 py-2 px-3">
        <button class="btn btn-dark w-100 rounded-2" data-bs-dismiss="modal" style="font-size:0.875rem; padding:0.35rem 0;">Okay</button>
      </div>
    </div>
  </div>
</div>




  </div>
  <!-- ‚úÖ Staff Management Panel -->
<div id="staffListPanel" class="p-4 bg-light rounded-4 shadow-sm department-panel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-1"><i class="fas fa-users"></i> Staff Members</h3>
      <small class="text-muted">View and manage registered staff</small>
    </div>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#inviteStaffModal">
      <i class="fas fa-user-plus"></i> Invite Staff
    </button>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <!-- Search -->
      <div class="input-group mb-3">
        <input type="text" class="form-control" id="staffSearch" placeholder="Search by name or email">
        <button class="btn btn-outline-secondary"><i class="fas fa-search"></i></button>
      </div>

      <!-- Modern Staff Table -->
      <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
        <table class="table table-hover table-striped align-middle">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Joined</th>
              <th>Firebase UID</th>
              <th>Profile</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Position</th> <!-- ‚úÖ Added this -->
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="staffTableBody">
            <!-- Filled dynamically with JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


</div>






<!-- ‚úÖ Invite Staff Modal -->
<div class="modal fade" id="inviteStaffModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-user-plus"></i> Invite New Staff</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="inviteStaffForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="inviteEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <input type="text" class="form-control" id="inviteRole" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Department</label>
            <select class="form-select" id="inviteDepartment">
              <option value="">Select Department</option>
              <option value="1">IT</option>
              <option value="2">HR</option>
              <option value="3">Finance</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Position</label>
            <select class="form-select" id="invitePosition" required>
              <option value="">Select Position</option>
              <option value="QC Officer">QC Officer</option>
              <option value="Mailer Officer">Mailer Officer</option>
              <option value="Card Distributor">Card Distributor</option>
              <option value="Machine Operator">Machine Operator</option>
              <option value="Admin">Admin</option>
              <option value="HR">HR</option>
              <option value="Production Manager">Production Manager</option>
              <option value="Graphics/CTP">Graphics/CTP</option>
              <option value="Personnel">Personnel</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Invite</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- ‚úÖ Edit Staff Modal -->
<div class="modal fade" id="editStaffModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Staff</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editStaffForm">
        <div class="modal-body">
          <input type="hidden" id="editStaffId">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" id="editStaffName" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <input type="text" id="editStaffRole" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Department</label>
            <select id="editStaffDepartment" class="form-select"></select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ‚úÖ Delete Confirmation Modal -->
<div class="modal fade" id="deleteStaffModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-trash"></i> Delete Staff</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this staff member?
        <input type="hidden" id="deleteStaffId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmDeleteStaff" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>


<!-- ‚úÖ Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
  <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="successToastBody">Success!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>

  <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="errorToastBody">Something went wrong.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>


</div>


<!-- Internet Status Modal -->
<div id="networkStatusModal" class="network-modal shadow-lg rounded-3">
  <div class="d-flex align-items-start justify-content-between p-3">
    <div class="d-flex align-items-center gap-2">
      <i id="networkIcon" class="bi bi-wifi-off text-danger fs-4"></i>
      <div>
        <h6 id="networkMessage" class="mb-0 fw-bold text-danger">You are offline</h6>
        <small id="networkSubText" class="text-muted">Please check your connection.</small>
      </div>
    </div>
    <button type="button" id="closeNetworkModal" class="btn-close ms-3"></button>
  </div>
</div>

<!-- Fetch Status Modal -->
<div id="fetchStatusModal" class="fetch-modal shadow-lg rounded-4">
  <div class="fetch-inner d-flex align-items-center gap-3">
    <div id="fetchIcon" class="fetch-icon"></div>
    <div>
      <h6 id="fetchMessage" class="mb-0 fw-semibold text-primary">Loading data...</h6>
      <small id="fetchSubText" class="text-muted">Please wait while we process your request.</small>
    </div>
  </div>
  <button id="closeFetchModal" class="btn-close ms-auto"></button>
</div>
<!-- Discard Changes Confirmation Modal -->
<div class="modal fade" id="discardModal" tabindex="-1" aria-labelledby="discardModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content shadow-lg rounded-4 border-0" style="font-family: 'poppins">
      
      <!-- Modal Header -->
      <div class="modal-header bg-dark text-white rounded-top-4">
        <h5 class="modal-title d-flex align-items-center" id="discardModalLabel">
          <i class="fas fa-exclamation-circle me-2"></i> Unsaved Changes
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body d-flex align-items-center gap-2" style="font-size: 0.95rem;">
        <i class="fas fa-exclamation-triangle text-warning fa-lg"></i>
        <span>You have unsaved changes. Do you want to discard them?</span>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer justify-content-center gap-2 py-2">
        <button type="button" class="btn btn-sm btn-outline-secondary fw-semibold" id="continueEditBtn">
          <i class="fas fa-arrow-left me-1"></i> Continue
        </button>
        <button type="button" class="btn btn-sm btn-danger fw-semibold" id="discardChangesBtn">
          <i class="fas fa-trash-alt me-1"></i> Discard
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Discard Changes Modal -->
<div class="modal fade" id="discardDeviceModal" tabindex="-1" aria-labelledby="discardDeviceModalLabel" aria-hidden="true" style="display:none;">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 380px;">
    <div class="modal-content shadow-lg rounded-4" style="background-color: #fff; font-family: 'Segoe UI', sans-serif; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
      
      <!-- Modal Header -->
      <div class="modal-header" style="border-bottom: none; justify-content: center; padding: 1rem;">
        <h5 class="modal-title" style="font-size: 1rem; color: #000; text-align: center;">
          Discard Changes?
        </h5>
        <button type="button" class="btn-close" aria-label="Close" id="closeDiscardModalBtn" style="position: absolute; right: 1rem;"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body" style="text-align: center; padding: 1rem 1.5rem;">
        <div style="width: 50px; height: 50px; background-color: #ff6b00; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <i class="fas fa-exclamation-triangle" style="color: #fff; font-size: 1.3rem;"></i>
        </div>
        <p style="color: #000; font-size: 0.95rem; margin: 0;">
          You have unsaved changes. <br>
          Do you want to discard them?
        </p>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border-top: none; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem;">
        <button type="button" id="continueDeviceEditBtn" 
                style="background-color: #e0e0e0; color: #333; font-size: 0.85rem; padding: 0.5rem 1.2rem; border-radius: 0.5rem; border: none; transition: all 0.2s; cursor: pointer;"
                onmouseover="this.style.backgroundColor='#d5d5d5'" 
                onmouseout="this.style.backgroundColor='#e0e0e0'">
          Continue Editing
        </button>
        <button type="button" id="discardDeviceChangesBtn" 
                style="background-color: #ff6b00; color: #fff; font-size: 0.85rem; padding: 0.5rem 1.2rem; border-radius: 0.5rem; border: none; transition: all 0.2s; cursor: pointer;"
                onmouseover="this.style.backgroundColor='#e65a00'" 
                onmouseout="this.style.backgroundColor='#ff6b00'">
          Discard Changes
        </button>
      </div>
      
    </div>
  </div>
</div>



<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 380px;">
    <div class="modal-content shadow-lg rounded-3" style="background-color: #fff; font-family: 'Segoe UI', sans-serif;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="border-bottom: none; justify-content: center; padding: 1rem;">
        <h5 class="modal-title" style="font-size: 1rem; color: #000; text-align: center;">
          Confirm Deletion
        </h5>
        <button type="button" class="btn-close" aria-label="Close" id="cancelDeleteBtn" style="position: absolute; right: 1rem;"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body" style="text-align: center; padding: 1rem 1.5rem;">
        <div style="width: 50px; height: 50px; background-color: #ff6b00; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
          <i class="fas fa-exclamation-triangle" style="color: #fff; font-size: 1.3rem;"></i>
        </div>
        <p style="color: #000; font-size: 0.95rem; margin: 0;">
          Are you sure you want to delete this device? <br>
          <strong>All related data will be permanently removed!</strong>
        </p>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border-top: none; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem;">
        <button type="button" class="btn" id="cancelDeleteBtnFooter" 
                style="background-color: #e0e0e0; color: #333; font-size: 0.85rem; padding: 0.4rem 1rem; border-radius: 0.25rem;">
          Cancel
        </button>
        <button type="button" class="btn" id="confirmDeleteBtns" 
                style="background-color: #ff6b00; color: #fff; font-size: 0.85rem; padding: 0.4rem 1rem; border-radius: 0.25rem;">
          <i class="fas fa-trash-alt me-1"></i> Delete
        </button>
      </div>
      
    </div>
  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ============================================================
   GLOBAL CONFIG
============================================================ */

function showWarning(message) {
    document.getElementById("warningModalMessage").textContent = message;
    new bootstrap.Modal(document.getElementById("warningModal")).show();
}


let editedCell = null;
let oldValue = '';
let selectedBankId = null;
const userId = 4;

const dayFields = [
  'monday_day','monday_night',
  'tuesday_day','tuesday_night',
  'wednesday_day','wednesday_night',
  'thursday_day','thursday_night',
  'friday_day','friday_night',
  'saturday_day','saturday_night',
  'sunday_day','sunday_night'
];

let currentWeekDates = [];
let filteredMonth = null;

/* ============================================================
   UTILITIES
============================================================ */
const isValidNumber = value => /^-?\d*\.?\d+$/.test(String(value).trim());

function setCurrentWeekDates(baseDate = new Date()) {
  const monday = new Date(baseDate);
  monday.setDate(baseDate.getDate() - ((baseDate.getDay() + 6) % 7));
  currentWeekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    currentWeekDates.push(d);
  }
}

function formatDayWithDate(date) {
  return date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short' });
}

function getFieldForCell(cell) {
  const row = cell.closest('tr');
  const index = Array.from(row.children).indexOf(cell);
  if (index <= 0) return null;
  const field = dayFields[index - 1];
  return row.classList.contains('ot-row') ? `ot_${field}` : field;
}

function getBankIdForRow(row) {
  return row.dataset.bankId ? parseInt(row.dataset.bankId) : selectedBankId || null;
}

/* ============================================================
   RENDER HEADERS
============================================================ */
function renderTableHeaders() {
  const headerRow1 = document.querySelector("#qcTable thead tr:first-child");
  const headerRow2 = document.querySelector("#qcTable thead tr:nth-child(2)");
  if(!headerRow1 || !headerRow2) return;

  headerRow1.innerHTML = `<th rowspan="2">Bank / Client</th>`;
  headerRow2.innerHTML = '';

  currentWeekDates.forEach(d => {
    headerRow1.innerHTML += `<th colspan="2">${formatDayWithDate(d)}</th>`;
    headerRow2.innerHTML += `<th>Day</th><th>Night</th>`;
  });

  headerRow1.innerHTML += `<th rowspan="2">Total / Shift</th>`;
}

/* ============================================================
   FILTER ELEMENTS
============================================================ */
const filterMonth = document.getElementById('filterMonth');
const filterWeek = document.getElementById('filterWeek');
const filterBank = document.getElementById('filterBank');
const applyFilterBtn = document.getElementById('applyFilter');
const qcBankSelect = document.getElementById('qcBank'); // <-- QC Form select

/* ============================================================
   MONTH / WEEK FILTER
============================================================ */
function parseISOWeek(isoWeekStr) {
    const [year, week] = isoWeekStr.split('-W').map(Number);
    if (!year || !week) return null;
    const jan1 = new Date(year, 0, 1);
    const dayOffset = ((jan1.getDay() + 6) % 7);
    const firstMonday = new Date(jan1);
    firstMonday.setDate(jan1.getDate() + (7 - dayOffset));
    const mondayOfWeek = new Date(firstMonday);
    mondayOfWeek.setDate(firstMonday.getDate() + (week - 1) * 7);
    return mondayOfWeek;
}

filterMonth?.addEventListener('change', () => {
    if (!filterMonth.value) return;
    const [year, month] = filterMonth.value.split('-').map(Number);
    filteredMonth = { year, month };

    const firstOfMonth = new Date(year, month - 1, 1);
    const firstMonday = new Date(firstOfMonth);
    firstMonday.setDate(firstOfMonth.getDate() + ((8 - firstOfMonth.getDay()) % 7));

    setCurrentWeekDates(firstMonday);
    populateWeekOptions(year, month);
    renderTableHeaders();
    loadQcEntries();
});

filterWeek?.addEventListener('change', () => {
    if (!filterWeek.value) return;
    if (!filteredMonth) {
showWarning("Please select a month first!");
        filterWeek.value = "";
        return;
    }

    const weekStartDate = parseISOWeek(filterWeek.value);
    if (!weekStartDate) {
showWarning("Invalid week selected!");
        filterWeek.value = "";
        return;
    }

    if (weekStartDate.getFullYear() !== filteredMonth.year || weekStartDate.getMonth() !== filteredMonth.month - 1) {
showWarning("Selected week is outside the selected month!");
        filterWeek.value = "";
        return;
    }

    setCurrentWeekDates(weekStartDate);
    renderTableHeaders();
    loadQcEntries();
});

function populateWeekOptions(year, month) {
    if(!filterWeek) return;
    filterWeek.innerHTML = '';

    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);

    let monday = new Date(firstDay);
    monday.setDate(firstDay.getDate() + ((8 - firstDay.getDay()) % 7));

    while(monday <= lastDay) {
        const weekNumber = getWeekNumber(monday);
        const weekLabel = `Week ${weekNumber} (${monday.toLocaleDateString(undefined,{day:'numeric', month:'short'})} - ${new Date(monday.getTime() + 6*86400000).toLocaleDateString(undefined,{day:'numeric', month:'short'})})`;

        const option = document.createElement('option');
        option.value = `${monday.getFullYear()}-W${weekNumber}`;
        option.textContent = weekLabel;
        filterWeek.appendChild(option);

        monday.setDate(monday.getDate() + 7);
        if (monday.getMonth() !== month - 1) break;
    }
    filterWeek.value = "";
}

function getWeekNumber(d) {
    const date = new Date(d.getTime());
    date.setHours(0,0,0,0);
    date.setDate(date.getDate() + 4 - (date.getDay()||7));
    const yearStart = new Date(date.getFullYear(),0,1);
    return Math.ceil((((date - yearStart) / 86400000) + 1)/7);
}

/* ============================================================
   MAP ENTRIES
============================================================ */
/* ============================================================
   MAP ENTRIES (SHOW ALL BANKS)
============================================================ */
/* ============================================================
   MAP ENTRIES TO BANKS (SHOW ALL BANKS)
============================================================ */
async function mapEntriesByBank(entries) {
  const bankMap = {};

  // 1Ô∏è‚É£ Fetch all banks first
  let allBanks = [];
  try {
    const res = await fetch('http://localhost:4000/api/banks');
    allBanks = await res.json(); // array of all banks
  } catch(err) {
    console.error("Failed to fetch all banks:", err);
  }

  // 2Ô∏è‚É£ Initialize bankMap with all banks
  allBanks.forEach(bank => {
    bankMap[bank.bank_id] = { bank_id: bank.bank_id, bank_name: bank.bank_name, qc: {} };
  });

  // 3Ô∏è‚É£ Filter entries to current week
  let filteredEntries = entries.filter(e => {
    const entryDate = new Date(e.entry_date);
    return entryDate >= currentWeekDates[0] && entryDate <= currentWeekDates[6];
  });

  // 4Ô∏è‚É£ Apply bank filter if selected
  if(filterBank?.value){
    filteredEntries = filteredEntries.filter(e => e.bank_name === filterBank.value);
  }

  // 5Ô∏è‚É£ Merge QC entries into bankMap
  filteredEntries.forEach(e => {
    const date = new Date(e.entry_date);
    const dayIndex = (date.getDay() + 6) % 7;
    const field = e.shift === 'day' ? dayFields[dayIndex*2] : dayFields[dayIndex*2+1];

    if(!bankMap[e.bank_id]) {
      // safety fallback if entry has a bank not in allBanks
      bankMap[e.bank_id] = { bank_id: e.bank_id, bank_name: e.bank_name, qc: {} };
    }

    bankMap[e.bank_id].qc[field] = (bankMap[e.bank_id].qc[field] || 0) + e.quantity;
    if(e.overtime_qty > 0) {
      bankMap[e.bank_id].qc['ot_'+field] = (bankMap[e.bank_id].qc['ot_'+field] || 0) + e.overtime_qty;
    }
  });

  return Object.values(bankMap);
}

/* ============================================================
   CREATE BANK ROWS
============================================================ */
function createBankRows(tbody, bank) {
  const qcData = bank.qc;

  const mainRow = document.createElement('tr');
  mainRow.classList.add('main-row');
  mainRow.dataset.bankId = bank.bank_id;
  mainRow.innerHTML =
    `<td>${bank.bank_name}</td>` +
    dayFields.map(f => `<td contenteditable="true">${qcData[f] ?? 0}</td>`).join('') +
    `<td class="row-total">0</td>`;
  tbody.appendChild(mainRow);

  const otRow = document.createElement('tr');
  otRow.classList.add('ot-row');
  otRow.dataset.bankId = bank.bank_id;
  otRow.style.background = '#fff3d6';
  otRow.style.fontStyle = 'italic';
  otRow.style.borderLeft = '4px solid #ff6b00';
  otRow.innerHTML =
    `<td>Overtime</td>` +
    dayFields.map(f => `<td contenteditable="true">${qcData['ot_'+f] ?? 0}</td>`).join('') +
    `<td class="row-total">0</td>`;
  tbody.appendChild(otRow);
}

/* ============================================================
   LOAD QC ENTRIES
============================================================ */
// 1Ô∏è‚É£ Make latestLogsMap global
let latestLogsMap = {};

async function loadQcEntries() {
  try {
    // 1Ô∏è‚É£ Prepare query params
    const start = currentWeekDates[0].toISOString().split('T')[0];
    const end = currentWeekDates[6].toISOString().split('T')[0];
    const bankId = filterBank?.value || '';

    const queryParams = new URLSearchParams({ start_date: start, end_date: end });
    if (bankId) queryParams.append('bank_id', bankId);

    // 2Ô∏è‚É£ Fetch QC entries from backend
    const res = await fetch(`/api/qc/qc_entries?${queryParams.toString()}`);
    if (!res.ok) throw new Error("Failed to fetch QC entries");
    const { entries } = await res.json();

    // 3Ô∏è‚É£ Fetch logs filtered by the same date range
    const logRes = await fetch(`/api/qc/logs?start_date=${start}&end_date=${end}`);
    if (!logRes.ok) throw new Error("Failed to fetch QC logs");
    const { logs } = await logRes.json();

    // 4Ô∏è‚É£ Create map of latest log per bank_id + field
    latestLogsMap = {};
    logs.forEach(log => {
      const key = `${log.bank_id}_${log.changed_field}`;
      if (!latestLogsMap[key] || new Date(log.change_date) > new Date(latestLogsMap[key].change_date)) {
        latestLogsMap[key] = log;
      }
    });

    // 5Ô∏è‚É£ Fetch all banks
    let allBanks = [];
    try {
      const bankRes = await fetch('http://localhost:4000/api/banks');
      allBanks = await bankRes.json();
    } catch (err) {
      console.error("Failed to fetch banks:", err);
    }

    // 6Ô∏è‚É£ Initialize bankMap
    const bankMap = {};
    allBanks.forEach(bank => {
      bankMap[bank.bank_id] = { bank_id: bank.bank_id, bank_name: bank.bank_name, qc: {} };
    });

    // 7Ô∏è‚É£ Apply latest logs first (ensures edited-only cells are displayed)
    Object.values(latestLogsMap).forEach(log => {
      const bankId = log.bank_id;
      if (!bankMap[bankId]) return;
      bankMap[bankId].qc[log.changed_field] = parseFloat(log.new_value);
    });

    // 8Ô∏è‚É£ Merge QC entries on top of logs
entries.forEach(e => {
  const entryDate = new Date(e.entry_date);
  
  // Only populate if entryDate exists in currentWeekDates
  const dayIndex = currentWeekDates.findIndex(d =>
    d.getFullYear() === entryDate.getFullYear() &&
    d.getMonth() === entryDate.getMonth() &&
    d.getDate() === entryDate.getDate()
  );

  if (dayIndex === -1) return; // skip if entry is outside the week

  const field = e.shift === 'day' ? dayFields[dayIndex*2] : dayFields[dayIndex*2+1];

  if (!bankMap[e.bank_id]) {
    bankMap[e.bank_id] = { bank_id: e.bank_id, bank_name: e.bank_name, qc: {} };
  }

  bankMap[e.bank_id].qc[field] = e.quantity;

  if (e.overtime_qty > 0) {
    bankMap[e.bank_id].qc['ot_' + field] = e.overtime_qty;
  }
});

    // 9Ô∏è‚É£ Render table
    const tbody = document.getElementById('qcTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    generateTotalsRow(); // totals row first

    Object.values(bankMap).forEach(bank => createBankRows(tbody, bank));

    recalcTotals(); // recalc totals after rendering

    // üîü Attach hover tooltips to editable cells
    document.querySelectorAll('#qcTableBody td[contenteditable="true"]').forEach(cell => {
      cell.addEventListener('mouseenter', () => {
        const row = cell.closest('tr');
        const bankId = getBankIdForRow(row);
        const field = getFieldForCell(cell);
        if (!bankId || !field) return;

        const log = latestLogsMap[`${bankId}_${field}`];
        if (!log) return;

        const existing = document.querySelector('.edit-tooltip');
        if (existing) existing.remove();

        const tooltip = document.createElement('div');
        tooltip.classList.add('edit-tooltip');
        tooltip.style.position = 'absolute';
        tooltip.style.background = '#fff9c4';
        tooltip.style.border = '1px solid #ffca28';
        tooltip.style.padding = '4px 8px';
        tooltip.style.fontSize = '12px';
        tooltip.style.zIndex = '999';
        tooltip.style.borderRadius = '4px';
        tooltip.innerHTML = `
          <strong>Last edit:</strong><br>
          Old: ${log.old_value}<br>
          New: ${log.new_value}<br>
          By User ID: ${log.user_id}<br>
          At: ${new Date(log.change_date).toLocaleString()}<br>
          Reason: ${log.reason || '-'}
        `;
        document.body.appendChild(tooltip);

        const rect = cell.getBoundingClientRect();
        tooltip.style.top = rect.bottom + window.scrollY + 'px';
        tooltip.style.left = rect.left + window.scrollX + 'px';

        cell.addEventListener('mouseleave', () => tooltip.remove(), { once: true });
      });
    });

  } catch (err) {
    console.error(err);
    showWarning("Failed to load QC entries");
  }
}





/* ============================================================
   FETCH BANKS FOR QC FORM
============================================================ */
async function loadBanksForForm() {
  if(!qcBankSelect) return;
  try {
    const res = await fetch('http://localhost:4000/api/banks');
    const banks = await res.json(); // directly an array
    console.log("Banks loaded:", banks);

    qcBankSelect.innerHTML = `<option value="">Select Bank</option>`;
    banks.forEach(bank => {
      const option = document.createElement('option');
      option.value = bank.bank_id;
      option.textContent = bank.bank_name;
      qcBankSelect.appendChild(option);
    });
  } catch(err) {
    console.error("Error loading banks:", err);
    qcBankSelect.innerHTML = `<option value="">‚ö† Failed to load banks</option>`;
  }
}


/* ============================================================
   TOTALS
============================================================ */
function generateTotalsRow() {
  const totalRow = document.querySelector('.totals-row');
  if(!totalRow) return;

  totalRow.innerHTML =
    `<td>Total / Shift</td>` +
    Array.from({length: 14}, (_, i) => `<td class="${i%2?'night':'day'}-total">0</td>`).join('') +
    `<td class="total-shift">0</td>`;
}



function recalcTotals() {
  const totalRow = document.querySelector('.totals-row');
  if (!totalRow) return;

  const dayTotals = totalRow.querySelectorAll('.day-total');
  const nightTotals = totalRow.querySelectorAll('.night-total');

  // Reset row totals
  document.querySelectorAll('.main-row, .ot-row').forEach(row => {
    const cells = Array.from(row.querySelectorAll('td[contenteditable="true"]'));
    const rowTotal = cells.reduce((sum, cell) => sum + (parseFloat(cell.textContent) || 0), 0);
    row.querySelector('.row-total').textContent = rowTotal;
  });

  // Calculate column totals
  for (let i = 0; i < 7; i++) {
    let daySum = 0, nightSum = 0;
    document.querySelectorAll('.main-row, .ot-row').forEach(row => {
      const cells = Array.from(row.querySelectorAll('td[contenteditable="true"]'));
      daySum += parseFloat(cells[i*2]?.textContent) || 0;
      nightSum += parseFloat(cells[i*2+1]?.textContent) || 0;
    });
    if (dayTotals[i]) dayTotals[i].textContent = daySum;
    if (nightTotals[i]) nightTotals[i].textContent = nightSum;
  }

  // Calculate total shift sum
  const totalShift = Array.from(dayTotals)
    .concat(Array.from(nightTotals))
    .reduce((sum, td) => sum + (parseFloat(td.textContent) || 0), 0);
  totalRow.querySelector('.total-shift').textContent = totalShift;
}


/* ============================================================
   CELL EDIT + LOG
============================================================ */
document.addEventListener('focusin', e=>{
  if(e.target.matches('[contenteditable="true"]')){
    oldValue=e.target.textContent.trim();
    editedCell=e.target;
  }
});

document.addEventListener('focusout', e=>{
  const cell=e.target;
  if(!cell.matches('[contenteditable="true"]')) return;
  const newValue=cell.textContent.trim();
  if(!isValidNumber(newValue)){
    showWarning("Please enter a valid number.");
    cell.textContent = oldValue;
    return;
}

  if(newValue===oldValue) return;

  const field=getFieldForCell(cell);
  const bankId=getBankIdForRow(cell.closest('tr'));
  if(!field||!bankId){ cell.textContent=oldValue; return; }

  const form=document.getElementById('editConfirmForm');
  form.dataset.field=field;
  form.dataset.old=oldValue;
  form.dataset.new=newValue;
  form.dataset.rowBankId=bankId;

  new bootstrap.Modal(document.getElementById('editConfirmModal')).show();
});

/* ============================================================
   SAVE LOG
============================================================ */
document.getElementById('editConfirmForm')?.addEventListener('submit', async e => {
  e.preventDefault();
  
  const form = e.currentTarget;
  const reason = document.getElementById('changeRemark').value.trim();

  if (!reason) {
    showWarning("Please enter a reason for this change.");
    return;
  }

  const payload = {
    bank_id: parseInt(form.dataset.rowBankId),
    user_id: userId,
    changed_field: form.dataset.field,
    old_value: form.dataset.old,
    new_value: form.dataset.new,
    reason
  };

  try {
    const res = await fetch('/api/qc/logs', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Failed to save edit");

    const data = await res.json();

    // ‚úÖ Update the table cell visually
    if (editedCell) {
      const isOvertime = form.dataset.field.startsWith('ot_');
      editedCell.textContent = form.dataset.new; // display new value
    }

    // ‚úÖ Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('editConfirmModal'));
    if (modal) modal.hide();
    form.reset();

    // ‚úÖ Optionally, recalc totals if needed
    if (typeof recalcTotals === 'function') recalcTotals();

    // ‚úÖ Show success message
    showWarning("Change saved successfully!");

  } catch (err) {
    console.error("Edit save error:", err);

    // Restore old value if something went wrong
    if (editedCell) editedCell.textContent = form.dataset.old;

    showWarning("Failed to save change. Please try again.");
  }
});


/* ============================================================
   APPLY FILTER BUTTON
============================================================ */
applyFilterBtn?.addEventListener('click', () => {
  loadQcEntries();
});

/* ============================================================
   INITIAL LOAD
============================================================ */
document.addEventListener('DOMContentLoaded', async()=>{
  setCurrentWeekDates();
  renderTableHeaders();
  await loadQcEntries();
  await loadBanksForForm(); // <-- load banks for QC form
});


/* ============================================================
   ADD QC ENTRY FORM SUBMIT  (FIXED FOR YOUR MODAL)
============================================================ */
document.getElementById('editConfirmForm')?.addEventListener('submit', async e => {
    e.preventDefault();

    const form = e.currentTarget;
    const reason = document.getElementById('changeRemark').value.trim();

    // ‚úÖ Ensure reason is provided
    if (!reason) {
        showWarning("Please enter a reason for this change.");
        return;
    }

    // ‚úÖ Prevent editing future dates
    const today = new Date();
    const editDate = new Date(entryDate); // entryDate should be in 'YYYY-MM-DD' format

    // Normalize time to midnight for proper comparison
    today.setHours(0,0,0,0);
    editDate.setHours(0,0,0,0);

    if (editDate > today) {
        showWarning("You cannot edit entries for future dates.");
        return;
    }

    // Prepare payload for backend
    const payload = {
        bank_id: parseInt(form.dataset.rowBankId),
        user_id: userId,
        changed_field: form.dataset.field,
        old_value: form.dataset.old,
        new_value: form.dataset.new,
        reason,
        entry_date: entryDate
    };

    try {
        // Send update to server
        const res = await fetch('/api/qc/logs', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Server error while saving edit");

        const data = await res.json();

        // Update the table cell immediately
        if (editedCell && data.updatedEntry) {
            const isOvertime = form.dataset.field.startsWith('ot_');
            editedCell.textContent = isOvertime
                ? data.updatedEntry.overtime_qty
                : data.updatedEntry.quantity;
        }

        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('editConfirmModal'));
        if (modal) modal.hide();
        form.reset();

        // Reload table so changes persist after refresh
        await loadQcEntries();

        // Show success message
        showWarning("Change saved successfully!");

    } catch (err) {
        console.error("Edit save error:", err);
        if (editedCell) editedCell.textContent = form.dataset.old;
        showWarning("Failed to save change. Please try again.");
    }
});






/* ============================================================
   SHOW/HIDE OVERTIME FIELD
============================================================ */
document.addEventListener("DOMContentLoaded", () => {

  const addQCForm = document.getElementById("addQCForm");
  const qcBankSelect = document.getElementById("qcBank");
  const qcShiftSelect = document.getElementById("qcShift");
  const qcTotalInput = document.getElementById("qcTotal");
  const overtimeSwitch = document.getElementById("overtimeSwitch");
  const overtimeQtyDiv = document.getElementById("overtimeQtyDiv");
  const overtimeQtyInput = document.getElementById("overtimeQty");

  // Show/hide overtime quantity input
  overtimeSwitch.addEventListener("change", () => {
    if (overtimeSwitch.checked) {
      overtimeQtyDiv.style.display = "block";
      overtimeQtyInput.required = true;
    } else {
      overtimeQtyDiv.style.display = "none";
      overtimeQtyInput.required = false;
      overtimeQtyInput.value = "";
    }
  });

  // Load banks into select
  async function loadBanks() {
    try {
      const res = await fetch("/api/banks"); // adjust endpoint if different
      const data = await res.json();
      if (data.success) {
        qcBankSelect.innerHTML = '<option value="">-- Select Bank --</option>';
        data.banks.forEach(bank => {
          const option = document.createElement("option");
          option.value = bank.bank_id;
          option.textContent = bank.bank_name;
          qcBankSelect.appendChild(option);
        });
      }
    } catch (err) {
      console.error("Error loading banks:", err);
    }
  }

  loadBanks();

  // Handle form submission
  addQCForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const payload = {
      bank_id: qcBankSelect.value,
      shift: qcShiftSelect.value,
      entry_date: new Date().toISOString().split("T")[0], // today's date
      quantity: parseInt(qcTotalInput.value),
      overtime: overtimeSwitch.checked,
      overtime_qty: overtimeSwitch.checked ? parseInt(overtimeQtyInput.value) : 0
    };

    try {
      const res = await fetch("/api/qc/qc_entries", {   // adjust API endpoint
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (data.success) {
        alert("‚úÖ QC Entry added successfully!");
        addQCForm.reset();
        overtimeQtyDiv.style.display = "none";

        // Hide modal
        const modalEl = document.getElementById("qcEntryModalUnique");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        // ‚úÖ Reload table immediately after adding
        await loadQcEntries(); // This will fetch and update the table without refreshing

      } else {
        alert("‚ùå Error adding entry: " + (data.error || "Unknown"));
      }

    } catch (err) {
      console.error("Add QC Error:", err);
      alert("‚ùå Server error while adding QC entry.");
    }
  });

});

</script>




<script>


  const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
const API_BASE = isLocal ? "http://localhost:4000" : "https://department-app-n2tj.onrender.com";


// Show Bootstrap modal when offline/online changes
function showNetworkModal(status) {
  const modal = new bootstrap.Modal(document.getElementById('networkStatusModal'));
  const icon = document.getElementById('networkIcon');
  const message = document.getElementById('networkMessage');
  const content = document.getElementById('networkModalContent');

  if (status === 'offline') {
    icon.className = 'bi bi-wifi-off text-danger fs-1 mb-2';
    message.textContent = 'You are offline';
    content.classList.remove('bg-success', 'text-white');
    content.classList.add('bg-white');
    modal.show();
  } else {
    icon.className = 'bi bi-wifi text-success fs-1 mb-2';
    message.textContent = 'You are back online';
    content.classList.remove('bg-white');
    content.classList.add('bg-success', 'text-white');

    modal.show();

    // Auto close after 2 seconds
    setTimeout(() => {
      modal.hide();
    }, 2000);
  }
}

// Detect network changes
const modal = document.getElementById("networkStatusModal");
const icon = document.getElementById("networkIcon");
const message = document.getElementById("networkMessage");
const subText = document.getElementById("networkSubText");
const closeBtn = document.getElementById("closeNetworkModal");

function showNetworkModal(status) {
  modal.style.display = "block";

  if (status === "offline") {
    modal.classList.remove("online");
    icon.className = "bi bi-wifi-off text-danger fs-4";
    message.textContent = "You are offline";
    message.classList.replace("text-success", "text-danger");
    subText.textContent = "Please check your connection.";
  } else {
    modal.classList.add("online");
    icon.className = "bi bi-wifi text-success fs-4";
    message.textContent = "Back online";
    message.classList.replace("text-danger", "text-success");
    subText.textContent = "Your connection has been restored.";
    // Auto-hide after 2 seconds
    setTimeout(() => {
      modal.style.display = "none";
    }, 2000);
  }
}

// Listen for offline/online events
window.addEventListener("offline", () => showNetworkModal("offline"));
window.addEventListener("online", () => showNetworkModal("online"));

// Close button manually hides the modal
closeBtn.addEventListener("click", () => {
  modal.style.display = "none";
});

// Show if offline on load
window.addEventListener("load", () => {
  if (!navigator.onLine) showNetworkModal("offline");
});

const fetchModal = document.getElementById("fetchStatusModal");
const fetchIcon = document.getElementById("fetchIcon");
const fetchMessage = document.getElementById("fetchMessage");
const fetchSubText = document.getElementById("fetchSubText");
const fetchClose = document.getElementById("closeFetchModal");

function showFetchModal(type = "loading", message = "", subText = "") {
  fetchModal.style.display = "flex";
  fetchModal.classList.remove("error", "success");
  
  // Default messages
  fetchMessage.textContent = message || "Loading data...";
  fetchSubText.textContent = subText || "Please wait while we process your request.";

  // Loading State
  if (type === "loading") {
    fetchModal.classList.remove("error", "success");
    fetchMessage.classList = "mb-0 fw-semibold text-primary";
    fetchIcon.innerHTML = `
      <svg viewBox="0 0 50 50" width="32" height="32">
        <circle cx="25" cy="25" r="20" stroke="#0d6efd" stroke-width="4" fill="none" stroke-linecap="round" style="animation: spin 1s linear infinite;" />
      </svg>`;
  }

  // Success State
  else if (type === "success") {
    fetchModal.classList.add("success");
    fetchMessage.classList = "mb-0 fw-semibold text-success";
    fetchIcon.innerHTML = `
      <svg viewBox="0 0 52 52" width="32" height="32">
        <circle cx="26" cy="26" r="25" fill="none" stroke="#198754" stroke-width="3"/>
        <path fill="none" stroke="#198754" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"
              d="M14 27l7 7 16-16"
              style="stroke-dasharray: 24; stroke-dashoffset: 24; animation: checkmark 0.6s ease forwards;"/>
      </svg>`;
    setTimeout(() => (fetchModal.style.display = "none"), 2000);
  }

  // Error State
  else if (type === "error") {
    fetchModal.classList.add("error");
    fetchMessage.classList = "mb-0 fw-semibold text-danger";
    fetchIcon.innerHTML = `
      <svg viewBox="0 0 52 52" width="32" height="32">
        <circle cx="26" cy="26" r="25" fill="none" stroke="#dc3545" stroke-width="3"/>
        <path d="M16 16 L36 36 M36 16 L16 36"
              stroke="#dc3545" stroke-width="4" stroke-linecap="round" />
      </svg>`;
  }
}

fetchClose.addEventListener("click", () => (fetchModal.style.display = "none"));

// Example async call simulation
async function simulateFetch() {
  showFetchModal("loading", "Loading user dashboard...", "Fetching latest updates...");
  try {
    await new Promise(res => setTimeout(res, 2000));
    showFetchModal("success", "Data loaded successfully!", "Everything is up to date.");
  } catch {
    showFetchModal("error", "Error loading data", "Something went wrong.");
  }
}

document.addEventListener("DOMContentLoaded", simulateFetch);


// ‚úÖ Populate Department Dropdown dynamically with loading modal
async function populateDepartmentDropdown() {
  try {
    // Show custom loading modal
    showFetchModal("loading", "Loading departments...", "Please wait while we fetch the list.");

    const res = await fetch('/api/departments');
    if (!res.ok) throw new Error("Network response was not ok");

    const departments = await res.json();
    const select = document.getElementById('inviteDepartment');
    select.innerHTML = '<option value="">Select Department</option>';

    departments.forEach(dept => {
      const option = document.createElement('option');
      option.value = dept.id;
      option.textContent = dept.name;
      select.appendChild(option);
    });

    // ‚úÖ Success
    showFetchModal("success", "Departments loaded successfully!", "You can now select a department.");

  } catch (err) {
    console.error("Failed to load departments:", err);
    // ‚ùå Error
    showFetchModal("error", "Failed to load departments", "Please check your internet or try again.");
  }
}


// ‚úÖ Load departments whenever modal opens
const inviteModal = document.getElementById('inviteStaffModal');
if (inviteModal) {
  inviteModal.addEventListener('show.bs.modal', populateDepartmentDropdown);
}

// ‚úÖ Handle Staff Invite Form Submission with animated modal
document.getElementById('inviteStaffForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const email = document.getElementById('inviteEmail').value.trim();
  const role = document.getElementById('inviteRole').value;
  const department_id = document.getElementById('inviteDepartment').value || null;
  const position = document.getElementById('invitePosition').value; // üÜï Added position

  try {
    // üåÄ Show loading modal
    showFetchModal("loading", "Sending invitation...", "Please wait while we process your request.");

    const response = await fetch('/api/staff/invite', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, role, department_id, position })
    });

    const resultText = await response.text();
    let result;
    try {
      result = JSON.parse(resultText);
    } catch {
      throw new Error('Server returned non-JSON: ' + resultText.slice(0, 100));
    }

    if (response.ok) {
      // ‚úÖ Success modal animation
      showFetchModal("success", "Invitation sent successfully!", "The staff member will receive an email shortly.");

      // Reset form and close modal after short delay
      document.getElementById('inviteStaffForm').reset();
      const modal = bootstrap.Modal.getInstance(inviteModal);
      if (modal) setTimeout(() => modal.hide(), 1500);

      if (typeof loadStaffList === 'function') loadStaffList();
    } else {
      // ‚ùå Error modal animation
      const errorMessage = result.error || result.message || 'Something went wrong.';
      showFetchModal("error", "Failed to send invitation", errorMessage);
    }
  } catch (err) {
    // ‚ùå Network or unknown error
    showFetchModal("error", "Network Error", "Please check your connection and try again.");
    console.error(err);
  }
});

// ‚úÖ Load staff list into table
async function loadStaffList() {
  try {
    const res = await fetch('/api/staff/all'); // GET all staff
    const staff = await res.json();

    const tbody = document.getElementById('staffTableBody');
    tbody.innerHTML = '';

    staff.forEach((s, index) => {
      const joinedDate = new Date(s.created_at).toLocaleDateString('en-GB'); // DD/MM/YYYY
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${joinedDate}</td>
        <td>${s.firebase_uid}</td>
        <td>
          <img src="${s.profile_picture || 'https://via.placeholder.com/40'}" 
               alt="Profile" class="rounded-circle" width="40" height="40">
        </td>
        <td>${s.name}</td>
        <td>${s.email}</td>
        <td>${s.role}</td>
        <td>${s.department_id || '-'}</td>
        <td>${s.position || '-'}</td> <!-- ‚úÖ Added Position column -->
        <td class="text-center">
          <button class="btn btn-sm btn-warning me-2" 
            onclick="openEditModal(${s.id}, '${s.name}', '${s.username}', '${s.profile_picture || ''}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${s.id})">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  } catch (err) {
    showError('Failed to load staff list');
    console.error(err);
  }
}


// ‚úÖ Edit Staff Modal
function openEditModal(id, name, username, profile_picture) {
  document.getElementById('editStaffId').value = id;
  document.getElementById('editStaffName').value = name;
  document.getElementById('editStaffUsername').value = username;
  document.getElementById('editStaffProfile').value = profile_picture || '';

  const modal = new bootstrap.Modal(document.getElementById('editStaffModal'));
  modal.show();
}

document.getElementById('editStaffForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('editStaffId').value;
  const name = document.getElementById('editStaffName').value;
  const username = document.getElementById('editStaffUsername').value;
  const profile_picture = document.getElementById('editStaffProfile').value;

  try {
    const res = await fetch('/api/staff/edit', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, name, username, profile_picture })
    });
    const data = await res.json();

    if (res.ok) {
      showSuccess(data.message);
      loadStaffList();
      const modal = bootstrap.Modal.getInstance(document.getElementById('editStaffModal'));
      modal.hide();
    } else {
      showError(data.error || data.message);
    }
  } catch (err) {
    showError('Failed to edit staff');
    console.error(err);
  }
});

// ‚úÖ Delete Staff Modal
function openDeleteModal(id) {
  document.getElementById('deleteStaffId').value = id;
  const modal = new bootstrap.Modal(document.getElementById('deleteStaffModal'));
  modal.show();
}

document.getElementById('confirmDeleteStaff').addEventListener('click', async () => {
  const id = document.getElementById('deleteStaffId').value;
  try {
    const res = await fetch(`/api/staff/delete/${id}`, { method: 'DELETE' });
    const data = await res.json();

    if (res.ok) {
      showSuccess(data.message);
      loadStaffList();
      const modal = bootstrap.Modal.getInstance(document.getElementById('deleteStaffModal'));
      modal.hide();
    } else {
      showError(data.error || data.message);
    }
  } catch (err) {
    showError('Failed to delete staff');
    console.error(err);
  }
});

// ‚úÖ Initial load
loadStaffList();
document.addEventListener("DOMContentLoaded", () => {

  // ===================== OVERALL SUMMARY =====================
  async function loadOverallSummary() {
    try {
      const res = await fetch("/api/card-jobs/summary");
      const data = await res.json();
      document.getElementById("todayCount").textContent = data.today ?? 0;
      document.getElementById("weekCount").textContent = data.week ?? 0;
      document.getElementById("monthCount").textContent = data.month ?? 0;
      document.getElementById("topBank").textContent = data.topBank ?? "N/A";
    } catch (err) {
      console.error("Error loading overall summary:", err);
    }
  }

  // ===================== MULTI-BANK TREND =====================
  let overallChart;
  async function loadOverallTrend() {
    const bankId = document.getElementById("overallBankSelect").value;
    const filterType = document.getElementById("overallFilterType").value;

    let date;
    if (filterType === "week") date = document.getElementById("overallWeek")?.value;
    else if (filterType === "month") date = document.getElementById("overallMonth")?.value;

    if (!filterType) return;
    if (!date && filterType !== "custom") return;

    const start = document.getElementById("overallStartDate")?.value;
    const end = document.getElementById("overallEndDate")?.value;

    let query = `filterType=${filterType}`;
    if (filterType === "custom") {
      if (!start || !end) {
        alert("Please select start and end dates for custom range");
        return;
      }
      query += `&start=${start}&end=${end}`;
    } else {
      query += `&date=${date}`;
    }
    if (bankId) query += `&bankId=${bankId}`;

    try {
      const res = await fetch(`/api/card-jobs/multi-bank?${query}`);
      const data = await res.json();
      console.log("Multi-Bank Trend Data:", data);

      let labels = [];
      let datasets = [];

      if (!data.selectedBank.length && !data.otherBanks.length) {
        labels = ["No Data"];
        datasets = [{ label: "Cards Printed", data: [0], backgroundColor: "rgba(54,162,235,0.6)" }];
      } else {
        if (filterType === "week") labels = data.selectedBank.map(d => d.day);
        else if (filterType === "month") labels = data.selectedBank.map(d => `Week ${d.week}`);
        else labels = data.selectedBank.map(d => d.date || d.actual_date);

        datasets.push({
          label: "Selected Bank",
          data: data.selectedBank.map(d => d.total),
          borderColor: "#FF6700",
          backgroundColor: "rgba(255,103,0,0.3)",
          borderWidth: 2,
          tension: 0.4
        });

        data.otherBanks.forEach(bank => {
          datasets.push({
            label: bank.bankName,
            data: bank.data.map(d => d.total),
            borderColor: "#2196F3",
            backgroundColor: "rgba(33,150,243,0.2)",
            borderWidth: 2,
            tension: 0.4
          });
        });
      }

      const ctx = document.getElementById("overallPrintChart").getContext("2d");
      if (overallChart) overallChart.destroy();
      overallChart = new Chart(ctx, {
        type: filterType === "day" || filterType === "custom" ? "bar" : "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: {
            x: { title: { display: true, text: filterType === "month" ? "Weeks" : "Days" } },
            y: { title: { display: true, text: "Cards Printed" }, beginAtZero: true }
          }
        }
      });

    } catch (err) {
      console.error("Error loading overall trend:", err);
    }
  }

  // ===================== BANK CUSTOM SUMMARY =====================
async function loadBankCustomSummary() {
  const bankId = parseInt(document.getElementById("bankSelect_custom").value, 10); // ensure integer
  const month = document.getElementById("bankMonth_custom").value;
  const week = document.getElementById("bankWeek_custom").value;
  const start = document.getElementById("bankStart_custom").value;
  const end = document.getElementById("bankEnd_custom").value;

  if (!bankId) {
    alert("Please select a bank.");
    return;
  }

  // üß© Build query string
  let query = `bankId=${bankId}`;
  if (start && end) {
    query += `&filterType=custom&start=${start}&end=${end}`;
  } else if (week) {
    if (!month) {
      alert("Please select a month first before choosing a week.");
      return;
    }
    query += `&filterType=week&month=${month}`;
  } else if (month) {
    query += `&filterType=month&month=${month}`;
  } else {
    query += `&filterType=month`;
  }

  try {
    const res = await fetch(`/api/card-jobs/bank-calendar-summary?${query}`);
    const data = await res.json();
    console.log("‚úÖ Bank summary data:", data);

    const tbody = document.getElementById("bankSummary_custom");
    tbody.innerHTML = "";

    // üß© Handle backend messages or empty data
    if (data.message) {
      tbody.innerHTML = `<tr><td colspan="2" class="text-muted">${data.message}</td></tr>`;
      return;
    }

    if (!data.data || !data.data.length) {
      tbody.innerHTML = `<tr><td colspan="2" class="text-muted">No data available</td></tr>`;
      return;
    }

    // üïì Date formatter
    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      if (isNaN(date)) return "N/A";
      return date.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
    };

    // üßÆ Loop and display rows dynamically
    data.data.forEach(item => {
      let period = "N/A";

      if (item.date) {
        period = formatDate(item.date);
      } else if (item.week_start && item.week_end) {
        const start = formatDate(item.week_start);
        const end = formatDate(item.week_end);
        period = `${start} ‚Üí ${end}`;
      } else if (item.month) {
        const [y, m] = item.month.split("-");
        const monthName = new Date(item.month + "-01").toLocaleString("en-GB", { month: "long" });
        period = `${monthName} ${y}`;
      }

      const total = parseInt(item.total_cards ?? 0, 10);
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr>
           <td>${period}</td>
           <td>${total.toLocaleString()}</td>
         </tr>`
      );
    });

    // üßæ Display Total Summary
    if (data.total_cards !== undefined) {
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="fw-bold text-success border-top">
           <td>Total</td>
           <td>${parseInt(data.total_cards, 10).toLocaleString()}</td>
         </tr>`
      );
    }

  } catch (error) {
    console.error("‚ùå Error loading bank custom summary:", error);
    document.getElementById("bankSummary_custom").innerHTML =
      `<tr><td colspan="2" class="text-danger">Error loading data</td></tr>`;
  }
}


  // ===================== BANK JOBS TABLE =====================
 async function loadBankJobs() {
  const bankId = document.getElementById("bankSelect").value;
  const search = document.getElementById("searchInput").value.trim();
  const date = document.getElementById("dateInput").value;

  if (!bankId) {
    alert("Please select a bank.");
    return;
  }

  let query = `bankId=${bankId}`;
  if (search) query += `&search=${encodeURIComponent(search)}`;
  if (date) query += `&date=${date}`;

  try {
    const res = await fetch(`/api/card-jobs/bank-jobs?${query}`);
    const data = await res.json();

    console.log("Bank jobs:", data);
    const tbody = document.getElementById("bankJobsTableBody");
    tbody.innerHTML = "";

    if (!data || !data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-muted text-center py-3">
            No records found
          </td>
        </tr>`;
      return;
    }

    data.forEach(item => {
      // Backend already sends formatted date like: "Tuesday, 21 October 2025 at 03:00 PM"
      const formattedDate = item.created_at || "N/A";
      const qty = item.completed_qty ?? 0;
      const jobCode = item.job_code || "N/A";
      const staff = item.staff || "N/A";
      const device = item.device_name || "N/A";

      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr>
          <td>${formattedDate}</td>
          <td>${qty}</td>
          <td>${jobCode}</td>
          <td>${staff}</td>
          <td>${device}</td>
        </tr>`
      );
    });
  } catch (err) {
    console.error("Error loading bank jobs:", err);
    const tbody = document.getElementById("bankJobsTableBody");
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-danger text-center py-3">
          Error loading data
        </td>
      </tr>`;
  }
}


  // ===================== LOAD BANKS =====================
  async function loadBanks() {
    try {
      const res = await fetch("/api/banks");
      const banks = await res.json();

      const overallSelect = document.getElementById("overallBankSelect");
      const bankSelectCustom = document.getElementById("bankSelect_custom");
      const bankSelect = document.getElementById("bankSelect");

      [overallSelect, bankSelectCustom, bankSelect].forEach(sel => {
        sel.innerHTML =
          `<option value="">Select Bank</option>` +
          banks.map(b => `<option value="${b.bank_id}">${b.bank_name}</option>`).join("");
      });

      loadOverallSummary();
    } catch (err) {
      console.error("Error loading banks:", err);
    }
  }

  // ===================== EVENT LISTENERS =====================
  document.getElementById("applyOverall").addEventListener("click", loadOverallTrend);
  document.getElementById("bankApply_custom").addEventListener("click", loadBankCustomSummary);
  document.getElementById("applyBankJobs").addEventListener("click", loadBankJobs);

  // ===================== INIT =====================
  loadBanks();
});










</script>

<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');

  // ‚úÖ Only toggle on mobile
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('expanded');
    overlay.classList.toggle('active', sidebar.classList.contains('expanded'));
  }
}

// ‚úÖ Auto remove mobile overlay when resizing to desktop
window.addEventListener('resize', () => {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');

  if (window.innerWidth > 768) {
    sidebar.classList.add('expanded'); // Always open on desktop
    overlay.classList.remove('active');
  } else {
    sidebar.classList.remove('expanded'); // Start collapsed on mobile
  }
});

// ‚úÖ Close sidebar when overlay is clicked (mobile only)
document.getElementById('overlay')?.addEventListener('click', () => {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  sidebar.classList.remove('expanded');
  overlay.classList.remove('active');
});

// ‚úÖ Keep submenu toggle behavior
document.querySelectorAll('.nav-item > .nav-link').forEach(link => {
  link.addEventListener('click', function (e) {
    e.preventDefault();
    const target = this.getAttribute('data-bs-target');
    const submenu = document.querySelector(target);

    document.querySelectorAll('.nav-item .collapse.show').forEach(openMenu => {
      if (openMenu !== submenu) openMenu.classList.remove('show');
    });

    submenu.classList.toggle('show');
  });
});

// ‚úÖ Keep department panel switching
document.querySelectorAll('.nav-link[data-target]').forEach(link => {
  link.addEventListener('click', function (e) {
    e.preventDefault();
    const targetId = this.getAttribute('data-target');
    if (!targetId) return;

    document.querySelectorAll('.department-panel').forEach(panel => {
      panel.style.display = 'none';
    });

    document.getElementById(targetId).style.display = 'block';

    // Auto close sidebar on mobile only
    if (window.innerWidth <= 768) toggleSidebar();
  });
});

// ‚úÖ Run once on page load
window.addEventListener('load', () => {
  const sidebar = document.getElementById('sidebar');

  // Always expanded on desktop
  if (window.innerWidth > 768) sidebar.classList.add('expanded');

  // ‚úÖ Add smooth fade-in when page finishes loading
  sidebar.classList.add('ready');
});



//function for job list for stafff dashbpard
window.addEventListener('DOMContentLoaded', () => {
    // ‚úÖ DOM Elements
    const staffSelect = document.getElementById('staffSelect');
    const jobTableBody = document.getElementById('staffJobsTableBody');
    const jobSearchInput = document.getElementById('jobSearchjob');
    const jobSearchBtn = document.getElementById('jobSearchBtnjob');
    const customDateStart = document.getElementById('customDateStart');
    const customDateEnd = document.getElementById('customDateEnd');
    const customDateBtn = document.getElementById('customDateSearchBtnjob');
    const staffChartCanvas = document.getElementById('staffJobChart');

    if (!staffSelect || !jobTableBody || !staffChartCanvas) {
        console.error('‚ùå Missing required DOM elements.');
        return;
    }

    let allStaff = [];
    let allJobs = [];
    let currentStaff = null;

    // üîπ Load all staff (Mailer Officers + Machine Operators)
    async function loadStaff() {
        try {
            const res = await fetch('/api/person-team/staff');
            allStaff = await res.json();
            staffSelect.innerHTML = '<option value="">-- Select Staff --</option>';

            allStaff.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.name} (${s.position})`;
                staffSelect.appendChild(opt);
            });
        } catch (err) {
            console.error('‚ùå Failed to load staff:', err);
        }
    }

    // üîπ Fetch jobs for selected staff (initial load, no date filter)
    async function fetchJobsForStaff() {
        const userId = staffSelect.value;
        if (!userId) return;

        currentStaff = allStaff.find(s => s.id == userId);
        if (!currentStaff) return;

        try {
            let url = currentStaff.position.toLowerCase().includes('operator')
                ? `/api/person-team/staff/${userId}/cardjobs`
                : `/api/person-team/staff/${userId}/jobs`;

            console.log('üîπ Fetching jobs for staff:', url);

            const res = await fetch(url);
            const data = await res.json();

            allJobs = Array.isArray(data) ? data : data.jobs || [];

            renderJobTable(allJobs, data.noJobDays);
            renderJobChart(allJobs);
        } catch (err) {
            console.error('‚ùå Failed to fetch jobs:', err);
        }
    }

    // üîπ Fetch jobs with custom date filter
    async function fetchJobsByDate() {
        const userId = staffSelect.value;
        if (!userId) {
            alert('Please select a staff first');
            return;
        }

        currentStaff = allStaff.find(s => s.id == userId);
        if (!currentStaff) return;

        let url = currentStaff.position.toLowerCase().includes('operator')
            ? `/api/person-team/staff/${userId}/cardjobs`
            : `/api/person-team/staff/${userId}/jobs`;

        const params = new URLSearchParams();
        if (customDateStart.value) params.append('startDate', customDateStart.value);
        if (customDateEnd.value) params.append('endDate', customDateEnd.value);
        if ([...params].length > 0) url += '?' + params.toString();

        console.log('üîπ Fetching jobs with date filter:', url);

        try {
            const res = await fetch(url);
            const data = await res.json();
            const filteredJobs = Array.isArray(data) ? data : data.jobs || [];

            renderJobTable(filteredJobs, data.noJobDays);
            renderJobChart(filteredJobs);
        } catch (err) {
            console.error('‚ùå Failed to fetch jobs by date:', err);
        }
    }

    // üîπ Render job table (for both Mailer & Operator)
    function renderJobTable(jobs, noJobDays = []) {
        jobTableBody.innerHTML = '';
        const tableHead = document.querySelector('#jobTable thead');
        if (!tableHead) return;

        // üü† If no jobs but backend provided "no job days"
        if ((!jobs || jobs.length === 0) && noJobDays.length > 0) {
            tableHead.innerHTML = `<tr><th>Date</th><th>Status</th></tr>`;
            noJobDays.forEach(day => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${day.day}</td><td>${day.message}</td>`;
                jobTableBody.appendChild(tr);
            });
            return;
        }

        if (!jobs.length) {
            jobTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No jobs found</td></tr>`;
            return;
        }

        const isCardJob = !!jobs[0].card_job_id;

        if (isCardJob) {
            // üü¢ Machine Operator jobs
            tableHead.innerHTML = `
                <tr>
                    <th>Time/Date</th>
                    <th>Job Code</th>
                    <th>Card Type</th>
                    <th>Qty</th>
                    <th>Completed</th>
                    <th>Rejected</th>
                    <th>Bank</th>
                    <th>Device</th>
                </tr>
            `;
            jobs.forEach(j => {
                const createdAt = new Date(j.created_at);
                const dateStr = createdAt.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                const timeStr = createdAt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const formatted = `${dateStr} at ${timeStr}`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatted}</td>
                    <td>${j.job_code}</td>
                    <td>${j.card_type}</td>
                    <td>${j.card_quantity}</td>
                    <td>${j.completed_qty}</td>
                    <td>${j.rejected_qty}</td>
                    <td>${j.bank_name || j.bank_id}</td>
                    <td>${j.device_name || j.device_id}</td>
                `;
                jobTableBody.appendChild(tr);
            });
        } else {
            // üîµ Mailer Officer jobs
            tableHead.innerHTML = `
                <tr>
                    <th>Job Code</th>
                    <th>Time</th>
                    <th>Date</th>
                    <th>Qty Printed</th>
                    <th>Amount</th>
                    <th>Range</th>
                    <th>Device</th>
                    <th>Staff</th>
                </tr>
            `;
            jobs.forEach(j => {
                const qty = j.range_end != null && j.range_start != null ? j.range_end - j.range_start : 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${j.job_code}</td>
                    <td>${new Date(j.created_at).toLocaleTimeString()}</td>
                    <td>${new Date(j.created_at).toLocaleDateString()}</td>
                    <td>${qty}</td>
                    <td>-</td>
                    <td>${j.range_start}-${j.range_end}</td>
                    <td>${j.device_name || j.device_id}</td>
                    <td>${j.operator_name || currentStaff.name}</td>
                `;
                jobTableBody.appendChild(tr);
            });
        }
    }

    // üîπ Render chart
    function renderJobChart(jobs) {
        const ctx = staffChartCanvas.getContext('2d');
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const data = days.map(() => 0);

        jobs.forEach(j => {
            const day = new Date(j.created_at).getDay(); // 0=Sun
            let qty = 0;
            if (j.range_start != null && j.range_end != null) qty = j.range_end - j.range_start;
            else if (j.completed_qty != null) qty = j.completed_qty;
            else if (j.card_quantity != null) qty = j.card_quantity;
            if (day >= 1 && day <= 6) data[day - 1] += qty;
        });

        if (window.staffChart) window.staffChart.destroy();

        window.staffChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: days, datasets: [{ label: 'Qty', data, backgroundColor: 'rgba(54,162,235,0.6)' }] },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Quantity' } } },
            },
        });
    }

    // üîπ Search Job Code
    jobSearchBtn.addEventListener('click', () => {
        const val = jobSearchInput.value.trim().toLowerCase();
        if (!val) {
            renderJobTable(allJobs); // Reset if input empty
            return;
        }

        const filtered = allJobs.filter(j =>
            (j.job_code || j.job_id || '').toLowerCase().includes(val)
        );

        if (filtered.length === 0) {
            jobTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No job found for "${val}"</td></tr>`;
            return;
        }

        renderJobTable(filtered);
    });

    // üîπ Event Listeners
    staffSelect.addEventListener('change', fetchJobsForStaff);
    customDateBtn.addEventListener('click', fetchJobsByDate);

    // üîπ Initialize
    loadStaff();
});



// ‚úÖ Fetch summary data for devices (total jobs printed, etc.)
window.addEventListener("DOMContentLoaded", async () => {
  const deviceSelect = document.getElementById("totalPrintDevice");
  const startDateInput = document.getElementById("customStartDate");
  const endDateInput = document.getElementById("customEndDate");
  const runBtn = document.getElementById("runCustomQuery");
  const totalValueEl = document.getElementById("startCustomTotalValue");
  const rawDataEl = document.getElementById("startCustomRawData");

  // ================================
  // Load Devices into dropdown
  // ================================
  async function loadDevices() {
    try {
      showFetchModal("loading", "Loading devices...", "Fetching available devices from the server.");
      const res = await fetch("/api/devices");
      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const devices = await res.json();

      deviceSelect.innerHTML = `<option value="">-- Select Device --</option>`;
      devices.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.device_id;
        opt.textContent = `${d.device_name} (${d.device_type})`;
        opt.dataset.type = d.device_type.toLowerCase(); // printer or card
        deviceSelect.appendChild(opt);
      });

      showFetchModal("success", "Devices loaded successfully!", "You can now select one to view print data.");
    } catch (err) {
      console.error("Failed to load devices:", err);
      showFetchModal("error", "Failed to load devices", err.message || "Please try again later.");
    }
  }

  // ================================
  // Fetch prints for selected device/date range
  // ================================
  async function fetchCustomPrints() {
    const deviceId = deviceSelect.value;
    const deviceType = deviceSelect.selectedOptions[0]?.dataset.type;
    const start = startDateInput.value;
    const end = endDateInput.value;

    if (!deviceId || !start || !end) {
      showFetchModal("error", "Missing Selection", "Please select a device and date range first.");
      return;
    }

    try {
      showFetchModal("loading", "Fetching data...", "Please wait while we load print summary data.");

      rawDataEl.textContent = "Loading data...";
      totalValueEl.textContent = "0";

      const url = `/api/checktotal/${deviceId}/custom-prints?start=${start}&end=${end}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const data = await res.json();

      const recordsByDay = data.recordsByDay || {};
      const totalPrints = data.totalPrints || 0;

      // Update total prints
      totalValueEl.textContent = totalPrints;

      // Build breakdown text
      let breakdownText = "";
      Object.keys(recordsByDay).sort().forEach(day => {
        const dayData = recordsByDay[day];
        breakdownText += `${day} - Total: ${dayData.dayTotal} prints\n`;

        dayData.jobs.forEach(job => {
          const jobText = deviceType === "printer"
            ? `  ${job.job_code}: ${job.prints} prints`
            : `  ${job.job_code}: ${job.prints} prints (Rejected: ${job.rejected_qty || 0})`;
          breakdownText += jobText + "\n";
        });
      });

      rawDataEl.textContent = breakdownText || "No prints found for this range.";
      showFetchModal("success", "Data loaded successfully!", "All summary data is now up to date.");
    } catch (err) {
      console.error("Failed to fetch custom prints:", err);
      rawDataEl.textContent = "Error fetching data.";
      showFetchModal("error", "Error loading data", err.message || "Please check your connection and retry.");
    }
  }

  // ================================
  // Event Listeners
  // ================================
  runBtn.addEventListener("click", fetchCustomPrints);

  // Load devices on page load
  loadDevices();
});


// deviceUsage.js
window.addEventListener("DOMContentLoaded", () => {
  // ================================
  // DOM ELEMENTS
  // ================================
  const deviceSelect = document.getElementById("deviceSelect");
  const timeRangeSelect = document.getElementById("timeRangeSelect");
  const weekPicker = document.getElementById("weekPicker");
  const monthPicker = document.getElementById("monthPicker");
  const chartCanvas = document.getElementById("deviceUsageChart");
  const chartTitle = document.getElementById("chartTitle");
  const jobsTableBody = document.getElementById("jobsTableBody");
  const jobsTableHeader = jobsTableBody.closest("table").querySelector("thead tr");

  const tonerDeviceSelect = document.getElementById("tonerDeviceSelect");
  const tonerTableBody = document.getElementById("tonerTableBody");
  const tonerSearchInput = document.getElementById("tonerSearch");
  const tonerSearchBtn = document.getElementById("tonerSearchBtn");
  const tonerDateStart = document.getElementById("tonerDateRangeStart");
  const tonerDateEnd = document.getElementById("tonerDateRangeEnd");
  const tonerDateSearchBtn = document.getElementById("tonerDateSearchBtn");

  // ================================
  // STATE
  // ================================
  let deviceChart = null;
  let allJobs = [];
  let allToners = [];
  let currentDeviceType = "printer";

  // ================================
  // LOAD DEVICES
    async function loadDevices() {
    try {
      const res = await fetch("/api/devices");
      const devices = await res.json();

      deviceSelect.innerHTML = `<option value="">-- Select Device --</option>`;
      tonerDeviceSelect.innerHTML = `<option value="">-- Select Device --</option>`;

      devices.forEach(d => {
        const opt1 = document.createElement("option");
        opt1.value = d.device_id;
        opt1.textContent = `${d.device_name} (${d.device_type})`;
        opt1.dataset.type = d.device_type;
        deviceSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = d.device_id;
        opt2.textContent = `${d.device_name} (${d.device_type})`;
        opt2.dataset.type = d.device_type;
        tonerDeviceSelect.appendChild(opt2);
      });
    } catch (err) {
      console.error("‚ùå Failed to load devices:", err);
    }
  }

  // ================================
  // JOBS TABLE
  // ================================
  function updateJobsTableHeader(deviceType) {
    if (deviceType === "printer") {
      jobsTableHeader.innerHTML = `
        <th>Job Code</th>
        <th>Range Start</th>
        <th>Range End</th>
        <th>Completed Qty</th>
      `;
    } else {
      jobsTableHeader.innerHTML = `
        <th>Job Code</th>
        <th>Date & Time</th>
        <th>Card Type</th>
        <th>Completed Qty</th>
        <th>Rejected Qty</th>
      `;
    }
  }

  function renderJobs(jobs, deviceType) {
    jobsTableBody.innerHTML = "";
    if (!jobs.length) {
      jobsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No jobs found</td></tr>`;
      return;
    }

    jobs.forEach(j => {
      const tr = document.createElement("tr");
      if (deviceType === "printer") {
        tr.innerHTML = `
          <td>${j.job_code}</td>
          <td>${j.range_start || 0}</td>
          <td>${j.range_end || 0}</td>
          <td>${j.completed_qty || (j.range_end - j.range_start + 1) || 0}</td>
        `;
      } else {
        tr.innerHTML = `
          <td>${j.job_code}</td>
          <td>${new Date(j.created_at).toLocaleString()}</td>
          <td>${j.card_type || "N/A"}</td>
          <td>${j.completed_qty || 0}</td>
          <td>${j.rejected_qty || 0}</td>
        `;
      }
      jobsTableBody.appendChild(tr);
    });
  }

  // ================================
  // TONER TABLE
  // ================================
  function renderTonerTable(records) {
    tonerTableBody.innerHTML = "";
    if (!records.length) {
      tonerTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No records found</td></tr>`;
      return;
    }

    records.sort((a, b) => new Date(b.install_date) - new Date(a.install_date))
      .forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.toner_code || t.encoder_code || "N/A"}</td>
          <td>${t.device_name || "N/A"}</td>
          <td>${new Date(t.install_date).toLocaleDateString()}</td>
          <td>${t.replace_date ? new Date(t.replace_date).toLocaleDateString() : ""}</td>
          <td>${t.total || t.total_prints || 0}</td>
        `;
        tonerTableBody.appendChild(tr);
      });
  }

  // ================================
  // GRAPH HELPERS
  // ================================
  function getWeekNumber(d) {
    const date = new Date(d);
    const start = new Date(date.getFullYear(), 0, 1);
    const diff = date - start + ((start.getDay() + 6) % 7) * 86400000;
    return Math.ceil(diff / 604800000);
  }

  function getDayName(d) {
    return new Date(d).toLocaleDateString("en-US", { weekday: "short" });
  }

  function buildGraphData(jobs, deviceType, viewType, selectedDate) {
    const data = {};

    if (!jobs || jobs.length === 0) return data;

    if (viewType === "week") {
      jobs.forEach(j => {
        const jobDate = new Date(j.created_at);
        const week = getWeekNumber(jobDate);
        if (selectedDate && parseInt(selectedDate) !== week) return;
        const day = getDayName(jobDate);
        if (!data[day]) data[day] = 0;

        const qty = j.completed_qty || (deviceType === "printer" ? (j.range_end - j.range_start + 1) : 0);
        data[day] += qty;
      });
    } else if (viewType === "month") {
      jobs.forEach(j => {
        const jobDate = new Date(j.created_at);
        const firstDayOfMonth = new Date(jobDate.getFullYear(), jobDate.getMonth(), 1);
        const weekOfMonth = Math.ceil((jobDate.getDate() + firstDayOfMonth.getDay()) / 7);
        const key = `Week ${weekOfMonth}`;
        if (!data[key]) data[key] = 0;

        const qty = j.completed_qty || (deviceType === "printer" ? (j.range_end - j.range_start + 1) : 0);
        data[key] += qty;
      });
    }

    return data;
  }

  function renderChart(graphData, deviceType, viewType) {
    if (!graphData || Object.keys(graphData).length === 0) {
      chartCanvas.style.display = "none";
      return;
    }

    chartCanvas.style.display = "block";
    const labels = Object.keys(graphData);
    const dataValues = labels.map(label => graphData[label]);

    if (deviceChart) deviceChart.destroy();
    deviceChart = new Chart(chartCanvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: `${deviceType.toUpperCase()} Usage`,
          data: dataValues,
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          borderColor: "#0d6efd"
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: `${deviceType.toUpperCase()} Usage Trend (${viewType})` }
        },
        scales: { y: { beginAtZero: true } }
      }
    });

    chartTitle.textContent = `${deviceType.toUpperCase()} Usage Trend (${viewType})`;
  }

  // ================================
  // FETCH DEVICE DATA
  // ================================
  async function fetchDeviceData() {
    const deviceId = deviceSelect.value;
    if (!deviceId) return;

    const viewType = timeRangeSelect.value;
    const selectedDate = viewType === "week" ? weekPicker.value : monthPicker.value;

    try {
      const historyRes = await fetch(`/api/devices/${deviceId}/history?view=${viewType}`);
      if (!historyRes.ok) throw new Error(`Server responded with status ${historyRes.status}`);
      const historyData = await historyRes.json();

      allJobs = historyData.jobs || [];
      currentDeviceType = historyData.deviceType || "printer";

      updateJobsTableHeader(currentDeviceType);
      renderJobs(allJobs, currentDeviceType);

      const graphData = buildGraphData(allJobs, currentDeviceType, viewType, selectedDate);
      renderChart(graphData, currentDeviceType, viewType);
    } catch (err) {
      console.error("‚ùå Device data fetch error:", err);
      jobsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load jobs</td></tr>`;
    }
  }

  // ================================
  // FETCH TONERS
  // ================================
  async function fetchToners() {
    const deviceId = tonerDeviceSelect.value;
    if (!deviceId) {
      tonerTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Please select a device</td></tr>`;
      return;
    }

    currentDeviceType = tonerDeviceSelect.selectedOptions[0]?.dataset.type || "printer";

    try {
      tonerTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Loading...</td></tr>`;
      const res = await fetch(`/api/devices/${deviceId}/usage`);
      if (!res.ok) throw new Error(`Server responded with status ${res.status}`);
      const data = await res.json();
      allToners = data.usage || [];
      renderTonerTable(allToners);
    } catch (err) {
      console.error("‚ùå Failed to fetch toner/encoder usage:", err);
      tonerTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load records</td></tr>`;
    }
  }

  // ================================
  // EVENTS
  // ================================
  deviceSelect.addEventListener("change", fetchDeviceData);
  timeRangeSelect.addEventListener("change", () => {
    if (timeRangeSelect.value === "week") {
      weekPicker.style.display = "block";
      monthPicker.style.display = "none";
    } else {
      weekPicker.style.display = "none";
      monthPicker.style.display = "block";
    }
    fetchDeviceData();
  });

  weekPicker.addEventListener("change", fetchDeviceData);
  monthPicker.addEventListener("change", fetchDeviceData);

  tonerDeviceSelect.addEventListener("change", fetchToners);
  tonerSearchBtn.addEventListener("click", () => {
    const val = tonerSearchInput.value.trim().toLowerCase();
    if (!val) return renderTonerTable(allToners);
    const filtered = allToners.filter(t => (t.toner_code || t.encoder_code || "").toLowerCase().includes(val));
    renderTonerTable(filtered);
  });
  tonerDateSearchBtn.addEventListener("click", () => {
    const start = tonerDateStart.value ? new Date(tonerDateStart.value) : null;
    const end = tonerDateEnd.value ? new Date(tonerDateEnd.value) : null;
    const filtered = allToners.filter(t => {
      const d = new Date(t.install_date);
      if (start && d < start) return false;
      if (end && d > end) return false;
      return true;
    });
    renderTonerTable(filtered);
  });

  // ================================
  // INITIAL LOAD
  // ================================
  loadDevices();
});


document.addEventListener("DOMContentLoaded", () => {
  const cardPrintingTableBody = document.getElementById("cardPrintingTableBody");
  const mailerPrintingTableBody = document.getElementById("mailerPrintingTableBody");

  const filterJobCode = document.getElementById("filterJobCode");
  const filterBank = document.getElementById("filterBank");
  const filterShift = document.getElementById("filterShift");
  const filterStartDate = document.getElementById("filterStartDate");
  const filterEndDate = document.getElementById("filterEndDate");

  const applyFiltersBtn = document.getElementById("applyFilters");
  const resetFiltersBtn = document.getElementById("resetFilters");

  let allJobs = [];
  let isFiltered = false;

  // =========================================================
  // üîπ Load Banks for Dropdown
  // =========================================================
  async function loadBanks() {
    try {
      const res = await fetch("/api/banks");
      const banks = await res.json();

      filterBank.innerHTML = `<option value="">All Banks</option>`;

      banks.forEach(bank => {
        const displayName = bank.bank_code
          ? `${bank.bank_code} - ${bank.bank_name}`
          : bank.bank_name;
        filterBank.insertAdjacentHTML(
          "beforeend",
          `<option value="${bank.bank_id}">${displayName}</option>`
        );
      });
    } catch (err) {
      console.error("Error loading banks:", err);
    }
  }

  // =========================================================
  // Fetch jobs from server
  // =========================================================
  async function loadJobData(filters = {}) {
    try {
      const params = new URLSearchParams();
      if (filters.jobCode) params.append("jobCode", filters.jobCode);
      if (filters.bankId) params.append("bankId", filters.bankId);
      if (filters.shift) params.append("shift", filters.shift);
      if (filters.startDate) params.append("startDate", filters.startDate);
      if (filters.endDate) params.append("endDate", filters.endDate);

      const res = await fetch(`/api/hi/job-management?${params.toString()}`);
      const data = await res.json();

      if (data.message === "No jobs found" || !Array.isArray(data) || data.length === 0) {
        showNoJobsMessage();
        return;
      }

      allJobs = Array.isArray(data) ? data : Object.values(data || {});
      displayJobs(allJobs);
    } catch (err) {
      console.error("Error loading jobs:", err);
      showNoJobsMessage("Error loading jobs");
    }
  }

  // =========================================================
  // Show "No Jobs" message
  // =========================================================
  function showNoJobsMessage(message = "No jobs found") {
    const msgRow = `<tr><td colspan="8" class="text-center text-muted py-3">${message}</td></tr>`;
    cardPrintingTableBody.innerHTML = msgRow;
    mailerPrintingTableBody.innerHTML = msgRow;
  }

  // =========================================================
  // Helpers
  // =========================================================
  function formatDateTime(datetime) {
    return new Date(datetime).toLocaleString();
  }

  function formatDateOnly(datetime) {
    const d = new Date(datetime);
    return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
  }

  // =========================================================
  // Display jobs grouped
  // =========================================================
  function displayJobs(jobs) {
    cardPrintingTableBody.innerHTML = "";
    mailerPrintingTableBody.innerHTML = "";

    let cardIndex = 1;
    let mailerIndex = 1;

    // ‚úÖ When filtered by date, group by date ‚Üí then by jobCode+bank
    if (isFiltered && filterStartDate.value && filterEndDate.value) {
      const groupedByDate = {};

      jobs.forEach(job => {
        const allDates = new Set([
          ...job.cardPrinting.map(b => formatDateOnly(b.createdAt)),
          ...job.mailerPrinting.map(b => formatDateOnly(b.createdAt)),
        ]);

        allDates.forEach(date => {
          if (!groupedByDate[date]) groupedByDate[date] = [];
          groupedByDate[date].push(job);
        });
      });

      Object.keys(groupedByDate)
        .sort((a, b) => new Date(a) - new Date(b))
        .forEach(date => {
          // üîπ Date header
          cardPrintingTableBody.insertAdjacentHTML("beforeend", `
            <tr class="table-info text-center fw-bold">
              <td colspan="8">${date}</td>
            </tr>
          `);
          mailerPrintingTableBody.insertAdjacentHTML("beforeend", `
            <tr class="table-info text-center fw-bold">
              <td colspan="8">${date}</td>
            </tr>
          `);

          // üîπ Group by Job Code + Bank under this date
          groupedByDate[date].forEach(job => {
            const cardHeaderId = `card-${job.jobCode}-${job.bankName}-${date}`;
            const mailerHeaderId = `mailer-${job.jobCode}-${job.bankName}-${date}`;

            // --- Card Printing ---
            const cardBatches = job.cardPrinting.filter(
              b => formatDateOnly(b.createdAt) === date
            );
            if (cardBatches.length) {
              cardPrintingTableBody.insertAdjacentHTML("beforeend", `
                <tr class="table-primary fw-bold text-center cursor-pointer" data-toggle="${cardHeaderId}">
                  <td colspan="8">${job.jobCode} - ${job.bankName}</td>
                </tr>
              `);
              cardBatches.forEach(batch => {
                cardPrintingTableBody.insertAdjacentHTML("beforeend", `
                  <tr class="text-center" data-group="${cardHeaderId}">
                    <td>${cardIndex++}</td>
                    <td>${formatDateTime(batch.createdAt)}</td>
                    <td>${batch.shift}</td>
                    <td>${batch.operator || '-'}</td>
                    <td>${batch.device || '-'}</td>
                    <td>${batch.totalQty || 0}</td>
                    <td>${batch.completedQty || 0}</td>
                    <td>${batch.remaining || 0}</td>
                  </tr>
                `);
              });
            }

            // --- Mailer Printing ---
            const mailerBatches = job.mailerPrinting.filter(
              b => formatDateOnly(b.createdAt) === date
            );
            if (mailerBatches.length) {
              mailerPrintingTableBody.insertAdjacentHTML("beforeend", `
                <tr class="table-primary fw-bold text-center cursor-pointer" data-toggle="${mailerHeaderId}">
                  <td colspan="8">${job.jobCode} - ${job.bankName}</td>
                </tr>
              `);
              mailerBatches.forEach(batch => {
                mailerPrintingTableBody.insertAdjacentHTML("beforeend", `
                  <tr class="text-center" data-group="${mailerHeaderId}">
                    <td>${mailerIndex++}</td>
                    <td>${formatDateTime(batch.createdAt)}</td>
                    <td>${batch.shift}</td>
                    <td>${batch.operator || '-'}</td>
                    <td>${batch.device || '-'}</td>
                    <td>${batch.totalQty || 0}</td>
                    <td>${batch.completedQty || 0}</td>
                    <td>${batch.remaining || 0}</td>
                  </tr>
                `);
              });
            }
          });
        });

    } else {
      // ‚úÖ Default: Group by Job Code + Bank (existing)
      jobs.forEach(job => {
        if (job.cardPrinting.length) {
          const cardHeaderId = `card-${job.jobCode}-${job.bankName}`;
          cardPrintingTableBody.insertAdjacentHTML("beforeend", `
            <tr class="table-primary fw-bold text-center cursor-pointer" data-toggle="${cardHeaderId}">
              <td colspan="8">${job.jobCode} - ${job.bankName}</td>
            </tr>
          `);
          job.cardPrinting.forEach(batch => {
            cardPrintingTableBody.insertAdjacentHTML("beforeend", `
              <tr class="text-center" data-group="${cardHeaderId}">
                <td>${cardIndex++}</td>
                <td>${formatDateTime(batch.createdAt)}</td>
                <td>${batch.shift}</td>
                <td>${batch.operator || '-'}</td>
                <td>${batch.device || '-'}</td>
                <td>${batch.totalQty || 0}</td>
                <td>${batch.completedQty || 0}</td>
                <td>${batch.remaining || 0}</td>
              </tr>
            `);
          });
        }

        if (job.mailerPrinting.length) {
          const mailerHeaderId = `mailer-${job.jobCode}-${job.bankName}`;
          mailerPrintingTableBody.insertAdjacentHTML("beforeend", `
            <tr class="table-primary fw-bold text-center cursor-pointer" data-toggle="${mailerHeaderId}">
              <td colspan="8">${job.jobCode} - ${job.bankName}</td>
            </tr>
          `);
          job.mailerPrinting.forEach(batch => {
            mailerPrintingTableBody.insertAdjacentHTML("beforeend", `
              <tr class="text-center" data-group="${mailerHeaderId}">
                <td>${mailerIndex++}</td>
                <td>${formatDateTime(batch.createdAt)}</td>
                <td>${batch.shift}</td>
                <td>${batch.operator || '-'}</td>
                <td>${batch.device || '-'}</td>
                <td>${batch.totalQty || 0}</td>
                <td>${batch.completedQty || 0}</td>
                <td>${batch.remaining || 0}</td>
              </tr>
            `);
          });
        }
      });
    }

    // ‚úÖ Collapsible behavior remains the same
    document.querySelectorAll("tr.cursor-pointer").forEach(header => {
      header.addEventListener("click", () => {
        const group = header.getAttribute("data-toggle");
        document.querySelectorAll(`tr[data-group="${group}"]`).forEach(row => {
          row.style.display = row.style.display === "none" ? "" : "none";
        });
      });
    });

    document.querySelectorAll("tr[data-group]").forEach(row => row.style.display = "none");
  }

  // =========================================================
  // Apply Filters
  // =========================================================
  applyFiltersBtn.addEventListener("click", () => {
    const filters = {
      jobCode: filterJobCode.value.trim(),
      bankId: filterBank.value.trim(),
      shift: filterShift.value,
      startDate: filterStartDate.value,
      endDate: filterEndDate.value
    };
    isFiltered = !!(filters.startDate || filters.endDate);
    loadJobData(filters);
  });

  // =========================================================
  // Reset Filters
  // =========================================================
  resetFiltersBtn.addEventListener("click", () => {
    filterJobCode.value = "";
    filterBank.value = "";
    filterShift.value = "";
    filterStartDate.value = "";
    filterEndDate.value = "";
    isFiltered = false;
    loadJobData();
  });

  // =========================================================
  // Initial Load
  // =========================================================
  loadBanks();   // ‚úÖ Load dropdown options first
  loadJobData(); // ‚úÖ Then load job data
});
// ----------------------
// Dynamic API Base
// ----------------------

// ----------------------
// DOM Elements
// ----------------------
const jobForm = document.getElementById("jobForm");
const jobIdInput = document.getElementById("jobId");
const bankSelect = document.getElementById("bankSelects");
const quantityInput = document.getElementById("quantity");
const modalElement = document.getElementById("jobModal");
const modalTitle = document.getElementById("jobModalLabel");
const submitBtn = jobForm.querySelector('button[type="submit"]');

const discardModalEl = document.getElementById("discardModal");
const discardBtn = document.getElementById("discardChangesBtn");
const continueBtn = document.getElementById("continueEditBtn");

const deleteModalEl = document.getElementById("deleteModal");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const closeDeleteModalBtn = document.getElementById("closeDeleteModal");

// Search Elements
const searchJobCode = document.getElementById("searchJobCode");
const searchStartDate = document.getElementById("searchStartDate");
const searchEndDate = document.getElementById("searchEndDate");
const applySearchBtn = document.getElementById("applySearch");

// State
let editingJobId = null;
let formDirty = false;
let deleteJobId = null;
let allJobs = []; // Store fetched jobs for filtering

// ----------------------
// Track Form Changes
// ----------------------
jobForm.addEventListener("input", () => formDirty = true);

// ----------------------
// Fetch Banks Dynamically
// ----------------------
async function fetchBanks(selectElementId) {
  const selectEl = document.getElementById(selectElementId);
  if (!selectEl) return console.error(`Element with id "${selectElementId}" not found.`);
  try {
    const res = await fetch(`https://department-app-n2tj.onrender.com/api/banks`);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const banks = await res.json();
    selectEl.innerHTML = `<option value="">-- Select Bank --</option>`;
    banks.forEach(bank => {
      const option = document.createElement("option");
      option.value = bank.bank_id;
      option.textContent = bank.bank_name;
      selectEl.appendChild(option);
    });
  } catch (err) {
    console.error("Error fetching banks:", err);
    selectEl.innerHTML = `<option value="">‚ö†Ô∏è Failed to load banks</option>`;
  }
}
fetchBanks("bankSelects");

// ----------------------
// Fetch Jobs
// ----------------------
async function fetchJobs() {
  try {
    const res = await fetch(`${API_BASE}/api/jobcode`);
    const jobs = await res.json();
    allJobs = jobs; // Store all jobs for search
    populateTable(jobs);
  } catch (err) {
    console.error("Error fetching jobs:", err);
  }
}

// ----------------------
// Filter Jobs
// ----------------------
function filterJobs(jobs) {
  const codeQuery = searchJobCode.value.trim().toLowerCase();
  const startDate = searchStartDate.value ? new Date(searchStartDate.value) : null;
  const endDate = searchEndDate.value ? new Date(searchEndDate.value) : null;

  return jobs.filter(job => {
    const jobDate = new Date(job.created_at);
    const matchesCode = codeQuery ? job.job_id.toLowerCase().includes(codeQuery) : true;
    const matchesStart = startDate ? jobDate >= startDate : true;
    const matchesEnd = endDate ? jobDate <= endDate : true;
    return matchesCode && matchesStart && matchesEnd;
  });
}

// ----------------------
// Apply Search
// ----------------------
applySearchBtn.addEventListener("click", () => {
  const filtered = filterJobs(allJobs);
  populateTable(filtered);
});

// ----------------------
// Populate Table (Grouped by Date, English format)
// ----------------------
function populateTable(jobs) {
  const tableBody = document.getElementById("processedJobsTableBody");
  tableBody.innerHTML = "";

  if (jobs.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="6">No jobs found for the selected criteria.</td></tr>`;
    return;
  }

  // Group jobs by date
  const grouped = jobs.reduce((acc, job) => {
    const dateKey = new Date(job.created_at).toDateString(); // e.g., "Fri Oct 11 2025"
    if (!acc[dateKey]) acc[dateKey] = [];
    acc[dateKey].push(job);
    return acc;
  }, {});

  let rowIndex = 1;

  Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
    const jobsForDate = grouped[date];

    // Add date header row with deep orange background and white text
    const dateRow = document.createElement("tr");
    dateRow.style.backgroundColor = "#FF6700"; // deep orange
    dateRow.style.color = "#ffffff"; // white text
    dateRow.innerHTML = `<td colspan="6" class="fw-bold text-start">${new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>`;
    tableBody.appendChild(dateRow);

    // Add jobs for this date
    jobsForDate.forEach(job => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${rowIndex++}</td>
        <td>${new Date(job.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
        <td>${job.job_id}</td>
        <td>${job.bank_name || "N/A"}</td>
        <td><span class="smart-badge ${job.processed ? 'success' : 'pending'}">
          ${job.processed ? 'Completed' : 'Pending'}</span></td>
        <td>
          <button class="smart-btn view me-1" data-id="${job.id}"><i class="fas fa-eye"></i></button>
          <button class="smart-btn edit me-1" data-id="${job.id}"><i class="fas fa-edit"></i></button>
          <button class="smart-btn delete" data-id="${job.id}"><i class="fas fa-trash"></i></button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  });

  addTableEventListeners();
}

// ----------------------
// Open Job Modal
// ----------------------
function openJobModal(mode = "add", job = null) {
  formDirty = false;
  if (mode === "add") {
    editingJobId = null;
    modalTitle.textContent = "Add Job";
    jobForm.reset();
    bankSelect.value = "";
    submitBtn.textContent = "Save Job";
  } else if (mode === "edit" && job) {
    editingJobId = job.id;
    modalTitle.textContent = "Edit Job";
    jobIdInput.value = job.job_id;
    quantityInput.value = job.quantity;
    bankSelect.value = job.bank_id || "";
    submitBtn.textContent = "Update Job";
  }
  showModal(modalElement);
}

// ----------------------
// Show / Close Modals
// ----------------------
function showModal(modalEl) {
  modalEl.classList.add("show");
  modalEl.style.display = "block";
  document.body.classList.add("modal-open");
  if (!document.querySelector(".modal-backdrop")) {
    const backdrop = document.createElement("div");
    backdrop.className = "modal-backdrop fade show";
    document.body.appendChild(backdrop);
  }
}

function closeModal(modalEl) {
  modalEl.classList.remove("show");
  modalEl.style.display = "none";
  document.body.classList.remove("modal-open");
  const backdrop = document.querySelector(".modal-backdrop");
  if (backdrop) backdrop.remove();
}

// ----------------------
// Handle Modal Close
// ----------------------
modalElement.addEventListener("click", (e) => { if (e.target === modalElement) handleModalClose(); });
document.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalElement.classList.contains("show")) handleModalClose(); });

function handleModalClose() {
  const isFormEmpty = !jobIdInput.value && !bankSelect.value && !quantityInput.value;
  if (!editingJobId && isFormEmpty) closeModal(modalElement);
  else showDiscardModal();
}

// ----------------------
// Discard Modal
// ----------------------
function showDiscardModal() { showModal(discardModalEl); }
discardBtn.addEventListener("click", () => {
  formDirty = false;
  editingJobId = null;
  jobForm.reset();
  bankSelect.value = "";
  modalTitle.textContent = "Add Job";
  submitBtn.textContent = "Save Job";
  closeModal(discardModalEl);
  closeModal(modalElement);
});
continueBtn.addEventListener("click", () => closeModal(discardModalEl));

// ----------------------
// Form Submit
// ----------------------
jobForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const jobId = jobIdInput.value.trim().toLowerCase();
  const bank_id = parseInt(bankSelect.value);
  const quantity = parseInt(quantityInput.value);
  const pattern1 = /^j\d{6}$/i;
  const pattern2 = /^wema_\d+$/i;
  if (!(pattern1.test(jobId) || (pattern2.test(jobId) && bank_id))) {
    alert("‚ö†Ô∏è Invalid Job ID. Use J123456 or wema_123456 (Wema Bank only).");
    return;
  }

  const payload = { job_id: jobId, bank_id, quantity, processed: true };
  try {
    let res;
    if (editingJobId) {
      res = await fetch(`${API_BASE}/api/jobcode/edit/${editingJobId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    } else {
      res = await fetch(`${API_BASE}/api/jobcode/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }
    await res.json();
    alert(`‚úÖ ${editingJobId ? "Job updated" : "Job added"} successfully`);
    jobForm.reset();
    editingJobId = null;
    formDirty = false;
    modalTitle.textContent = "Add Job";
    submitBtn.textContent = "Save Job";
    closeModal(modalElement);
    fetchJobs();
  } catch (err) {
    console.error("Error saving job:", err);
  }
});

// ----------------------
// Table Event Listeners
// ----------------------
function addTableEventListeners() {
  document.querySelectorAll(".smart-btn.edit").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const res = await fetch(`${API_BASE}/api/jobcode/${id}`);
      const job = await res.json();
      openJobModal("edit", job);
    });
  });

  document.querySelectorAll(".smart-btn.delete").forEach(btn => {
    btn.addEventListener("click", () => {
      deleteJobId = btn.dataset.id;
      showModal(deleteModalEl);
    });
  });

  document.querySelectorAll(".smart-btn.view").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const res = await fetch(`${API_BASE}/api/jobcode/${id}`);
      const job = await res.json();
      alert(`Job ID: ${job.job_id}\nBank: ${job.bank_name || "N/A"}\nQuantity: ${job.quantity}\nProcessed: ${job.processed ? "Yes" : "No"}`);
    });
  });
}

// ----------------------
// Delete Modal Behavior
// ----------------------
deleteModalEl.addEventListener("click", (e) => { if (e.target === deleteModalEl) { deleteJobId = null; closeModal(deleteModalEl); } });
if (closeDeleteModalBtn) closeDeleteModalBtn.addEventListener("click", () => { deleteJobId = null; closeModal(deleteModalEl); });
confirmDeleteBtn.addEventListener("click", async () => {
  if (!deleteJobId) return;
  try {
    await fetch(`${API_BASE}/api/jobcode/delete/${deleteJobId}`, { method: "DELETE" });
    deleteJobId = null;
    closeModal(deleteModalEl);
    fetchJobs();
  } catch (err) { console.error("Error deleting job:", err); }
});
cancelDeleteBtn.addEventListener("click", () => { deleteJobId = null; closeModal(deleteModalEl); });

// ----------------------
// Initial fetch
// ----------------------
fetchJobs();


 const batchButton = document.getElementById("batchButton");
  const jobProcessButton = document.getElementById("jobProcessButton");
  const batchSection = document.getElementById("batchSection");
  const jobProcessSection = document.getElementById("jobProcessSection");

  // üîπ When Batch button is clicked
  batchButton.addEventListener("click", () => {
    batchSection.style.display = "block";
    jobProcessSection.style.display = "none";

    batchButton.classList.add("btn-dark");
    batchButton.classList.remove("btn-outline-dark");
    jobProcessButton.classList.remove("btn-dark");
    jobProcessButton.classList.add("btn-outline-dark");
  });

  // üîπ When Job Process button is clicked
  jobProcessButton.addEventListener("click", () => {
    batchSection.style.display = "none";
    jobProcessSection.style.display = "block";

    jobProcessButton.classList.add("btn-dark");
    jobProcessButton.classList.remove("btn-outline-dark");
    batchButton.classList.remove("btn-dark");
    batchButton.classList.add("btn-outline-dark");
  });

</script>

<script>
(function() {
  // ----------------------
  // DOM Elements
  // ----------------------
  const showDevicesModal = document.getElementById("showDevicesModal");
  const addDeviceForm = document.getElementById("addDeviceForm");
  const deviceNameInput = document.getElementById("deviceName");
  const deviceTypeInput = document.getElementById("deviceType");
  const devicesTableBody = document.getElementById("devicesTableBody");
  const totalPrintDeviceSelect = document.getElementById("totalPrintDevice");

  const addDeviceModal = document.getElementById("addDeviceModal");
  const addDeviceModalTitle = document.getElementById("addDeviceModalLabel");
  const submitBtn = addDeviceForm.querySelector("button[type='submit']");

  const discardModal = document.getElementById("discardDeviceModal");
  const continueBtn = document.getElementById("continueDeviceEditBtn");
  const discardBtn = document.getElementById("discardDeviceChangesBtn");

  const deleteDeviceModal = document.getElementById("deleteDeviceModal");
  const confirmDeleteBtn = document.getElementById("confirmDeleteBtns");
  const cancelDeleteHeaderBtn = document.getElementById("cancelDeleteBtn");
  const cancelDeleteFooterBtn = document.getElementById("cancelDeleteBtnFooter");
  let deviceIdToDelete = null;

  // ----------------------
  // Device Type Dropdown
  // ----------------------
  const predefinedTypes = ["Printer", "Card Machine", "Sms Machine"];
  const deviceTypeSelect = document.createElement("select");
  deviceTypeSelect.className = "form-select mb-3";

  predefinedTypes.forEach(type => {
    const option = document.createElement("option");
    option.value = type;
    option.textContent = type;
    deviceTypeSelect.appendChild(option);
  });

  const otherOption = document.createElement("option");
  otherOption.value = "Other";
  otherOption.textContent = "Other (Enter manually)";
  deviceTypeSelect.appendChild(otherOption);

  deviceTypeInput.replaceWith(deviceTypeSelect);

  const deviceTypeTextInput = document.createElement("input");
  deviceTypeTextInput.type = "text";
  deviceTypeTextInput.className = "form-control mb-3";
  deviceTypeTextInput.placeholder = "Enter device type";
  deviceTypeTextInput.style.display = "none";
  deviceTypeSelect.after(deviceTypeTextInput);

  deviceTypeSelect.addEventListener("change", () => {
    deviceTypeTextInput.style.display = deviceTypeSelect.value === "Other" ? "block" : "none";
  });

  // ----------------------
  // State
  // ----------------------
  let editingDeviceId = null;
  let formDirty = false;
  let devices = [];

  addDeviceForm.addEventListener("input", () => formDirty = true);

  // ----------------------
  // Modal Helpers
  // ----------------------
  function showModal(modal) {
    modal.classList.add("show");
    modal.style.display = "block";
    document.body.classList.add("modal-open");
    if (!document.querySelector(".modal-backdrop")) {
      const backdrop = document.createElement("div");
      backdrop.className = "modal-backdrop fade show";
      document.body.appendChild(backdrop);
    }
  }

  function closeModal(modal) {
    modal.classList.remove("show");
    modal.style.display = "none";
    document.body.classList.remove("modal-open");
    const backdrop = document.querySelector(".modal-backdrop");
    if (backdrop) backdrop.remove();
  }

  // ----------------------
  // Open Add/Edit Modal
  // ----------------------
  function openDeviceModal(mode = "add", device = null) {
    formDirty = false;

    if (mode === "add") {
      editingDeviceId = null;
      addDeviceModalTitle.textContent = "Add Device";
      addDeviceForm.reset();
      deviceTypeTextInput.style.display = "none";
      submitBtn.textContent = "Save Device";
    } else if (mode === "edit" && device) {
      editingDeviceId = device.device_id;
      addDeviceModalTitle.textContent = "Edit Device";
      deviceNameInput.value = device.device_name;
      if (predefinedTypes.includes(device.device_type)) {
        deviceTypeSelect.value = device.device_type;
        deviceTypeTextInput.style.display = "none";
      } else {
        deviceTypeSelect.value = "Other";
        deviceTypeTextInput.style.display = "block";
        deviceTypeTextInput.value = device.device_type;
      }
      submitBtn.textContent = "Update Device";
    }

    closeModal(showDevicesModal); // ‚úÖ Close devices list when opening Add/Edit
    showModal(addDeviceModal);
  }

  // ----------------------
  // Handle Add/Edit Modal Close
  // ----------------------
  addDeviceModal.addEventListener("click", e => { if (e.target === addDeviceModal) handleModalClose(); });
  document.addEventListener("keydown", e => { if (e.key === "Escape" && addDeviceModal.classList.contains("show")) handleModalClose(); });

  function handleModalClose() {
    const currentData = {
      deviceName: deviceNameInput.value.trim(),
      deviceType: deviceTypeSelect.value === "Other" ? deviceTypeTextInput.value.trim() : deviceTypeSelect.value
    };
    const isFormEmpty = !currentData.deviceName && !currentData.deviceType;

    if (editingDeviceId || !isFormEmpty) showModal(discardModal);
    else closeModal(addDeviceModal);
  }

  // ----------------------
  // Discard Modal
  // ----------------------
  continueBtn.addEventListener("click", () => closeModal(discardModal));
  discardBtn.addEventListener("click", () => {
    editingDeviceId = null;
    addDeviceForm.reset();
    deviceTypeSelect.value = predefinedTypes[0];
    deviceTypeTextInput.value = "";
    deviceTypeTextInput.style.display = "none";
    addDeviceModalTitle.textContent = "Add Device";
    submitBtn.textContent = "Save Device";
    formDirty = false;
    closeModal(discardModal);
    closeModal(addDeviceModal);
  });

  // ----------------------
  // Delete Modal Handlers
  // ----------------------
  function showDeleteModal(id) {
    deviceIdToDelete = id;
    closeModal(showDevicesModal); // ‚úÖ Close devices list when opening Delete modal
    showModal(deleteDeviceModal);
  }

  function hideDeleteModal() {
    deviceIdToDelete = null;
    closeModal(deleteDeviceModal);
  }

  cancelDeleteHeaderBtn.addEventListener("click", hideDeleteModal);
  cancelDeleteFooterBtn.addEventListener("click", hideDeleteModal);

  confirmDeleteBtn.addEventListener("click", async () => {
    if (!deviceIdToDelete) return;
    try {
      const response = await fetch(`${API_BASE}/api/device/${deviceIdToDelete}`, { method: "DELETE" });
      if (!response.ok) return;
      deviceIdToDelete = null;
      fetchDevices();
      hideDeleteModal();
    } catch (err) { console.error(err); }
  });

  // ----------------------
  // Fetch Devices
  // ----------------------
  async function fetchDevices() {
    try {
      const res = await fetch(`${API_BASE}/api/device`);
      devices = await res.json();

      devicesTableBody.innerHTML = "";
      totalPrintDeviceSelect.innerHTML = `<option value="">-- Select Device --</option>`;

      devices.forEach((device, idx) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td>${device.device_name}</td>
          <td>${device.device_type}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-2 edit-btn" data-id="${device.device_id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${device.device_id}"><i class="fas fa-trash-alt"></i></button>
          </td>
        `;
        devicesTableBody.appendChild(row);

        const option = document.createElement("option");
        option.value = device.device_id;
        option.textContent = device.device_name;
        totalPrintDeviceSelect.appendChild(option);
      });

      addTableEventListeners();
    } catch (err) { console.error(err); }
  }

  // ----------------------
  // Table Event Listeners
  // ----------------------
  function addTableEventListeners() {
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const device = devices.find(d => d.device_id == btn.dataset.id);
        openDeviceModal("edit", device); // ‚úÖ closes showDevicesModal inside
      });
    });

    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", () => showDeleteModal(btn.dataset.id)); // ‚úÖ closes showDevicesModal inside
    });
  }

  // ----------------------
  // Add / Update Device
  // ----------------------
  addDeviceForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = deviceNameInput.value.trim();
    const type = deviceTypeSelect.value === "Other" ? deviceTypeTextInput.value.trim() : deviceTypeSelect.value;
    if (!name || !type) return alert("Please fill both fields.");

    const payload = { device_name: name, device_type: type };

    try {
      if (editingDeviceId) {
        await fetch(`${API_BASE}/api/device/${editingDeviceId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        editingDeviceId = null;
      } else {
        await fetch(`${API_BASE}/api/device`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }

      addDeviceForm.reset();
      deviceTypeTextInput.style.display = "none";
      addDeviceModalTitle.textContent = "Add Device";
      submitBtn.textContent = "Save Device";
      formDirty = false;
      fetchDevices();
      closeModal(addDeviceModal);
    } catch (err) { console.error(err); }
  });

  // ----------------------
  // Initial Fetch
  // ----------------------
  fetchDevices();

})();


</script>





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
